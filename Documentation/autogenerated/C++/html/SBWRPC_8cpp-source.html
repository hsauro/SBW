<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SBWRPC.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>SBWRPC.cpp</h1><a href="SBWRPC_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00013 <font class="comment">/*</font>
00014 <font class="comment">** Copyright 2001 California Institute of Technology and</font>
00015 <font class="comment">** Japan Science and Technology Corporation.</font>
00016 <font class="comment">** </font>
00017 <font class="comment">** This library is free software; you can redistribute it and/or modify it</font>
00018 <font class="comment">** under the terms of the GNU Lesser General Public License as published</font>
00019 <font class="comment">** by the Free Software Foundation; either version 2.1 of the License, or</font>
00020 <font class="comment">** any later version.</font>
00021 <font class="comment">** </font>
00022 <font class="comment">** This library is distributed in the hope that it will be useful, but</font>
00023 <font class="comment">** WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF</font>
00024 <font class="comment">** MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  The software and</font>
00025 <font class="comment">** documentation provided hereunder is on an "as is" basis, and the</font>
00026 <font class="comment">** California Institute of Technology and Japan Science and Technology</font>
00027 <font class="comment">** Corporation have no obligations to provide maintenance, support,</font>
00028 <font class="comment">** updates, enhancements or modifications.  In no event shall the</font>
00029 <font class="comment">** California Institute of Technology or the Japan Science and Technology</font>
00030 <font class="comment">** Corporation be liable to any party for direct, indirect, special,</font>
00031 <font class="comment">** incidental or consequential damages, including lost profits, arising</font>
00032 <font class="comment">** out of the use of this software and its documentation, even if the</font>
00033 <font class="comment">** California Institute of Technology and/or Japan Science and Technology</font>
00034 <font class="comment">** Corporation have been advised of the possibility of such damage.  See</font>
00035 <font class="comment">** the GNU Lesser General Public License for more details.</font>
00036 <font class="comment">** </font>
00037 <font class="comment">** You should have received a copy of the GNU Lesser General Public License</font>
00038 <font class="comment">** along with this library; if not, write to the Free Software Foundation,</font>
00039 <font class="comment">** Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</font>
00040 <font class="comment">**</font>
00041 <font class="comment">** The original code contained here was initially developed by:</font>
00042 <font class="comment">**</font>
00043 <font class="comment">**     Andrew Finney, Herbert Sauro, Michael Hucka, Hamid Bolouri</font>
00044 <font class="comment">**     The Systems Biology Workbench Development Group</font>
00045 <font class="comment">**     ERATO Kitano Systems Biology Project</font>
00046 <font class="comment">**     Control and Dynamical Systems, MC 107-81</font>
00047 <font class="comment">**     California Institute of Technology</font>
00048 <font class="comment">**     Pasadena, CA, 91125, USA</font>
00049 <font class="comment">**</font>
00050 <font class="comment">**     http://www.cds.caltech.edu/erato</font>
00051 <font class="comment">**     mailto:sysbio-team@caltech.edu</font>
00052 <font class="comment">**</font>
00053 <font class="comment">** Contributor(s):</font>
00054 <font class="comment">**</font>
00055 <font class="comment">*/</font>
00056 
00057 <font class="comment">// SBWRPC.cpp: implementation of the SBWRPC class.</font>
00058 <font class="comment">//</font>
00060 <font class="comment"></font>
00061 <font class="preprocessor">#include "<a class="code" href="stdafx_8h.html">stdafx.h</a>"</font>
00062 <font class="preprocessor">#include "<a class="code" href="SBWRPC_8h.html">SBWRPC.h</a>"</font>
00063 
00064 <font class="preprocessor">#ifdef WIN32</font>
00065 <font class="preprocessor"></font><font class="preprocessor">#include &lt;crtdbg.h&gt;</font>
00066 <font class="preprocessor">#endif</font>
00067 <font class="preprocessor"></font><font class="preprocessor">#include "<a class="code" href="portableOS_8h.html">portableOS.h</a>"</font>
00068 <font class="preprocessor">#include "<a class="code" href="DoNothingReceiver_8h.html">DoNothingReceiver.h</a>"</font>
00069 <font class="preprocessor">#include "<a class="code" href="DataBlockWriter_8h.html">DataBlockWriter.h</a>"</font>
00070 <font class="preprocessor">#include "<a class="code" href="DataBlockReaderClass_8h.html">DataBlockReaderClass.h</a>"</font>
00071 <font class="preprocessor">#include "<a class="code" href="RPCOutCall_8h.html">RPCOutCall.h</a>"</font>
00072 <font class="preprocessor">#include "<a class="code" href="RPCInCall_8h.html">RPCInCall.h</a>"</font>
00073 <font class="preprocessor">#include "<a class="code" href="SBWRPCListener_8h.html">SBWRPCListener.h</a>"</font>
00074 
00075 <font class="keyword">using</font> <font class="keyword">namespace </font>SystemsBiologyWorkbench ;
00076 
<a name="l00078"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#p0">00078</a> <font class="keyword">const</font> <font class="keywordtype">char</font> *SBWRPC::brokerServiceName = <font class="stringliteral">"BROKER"</font>;
00079 
<a name="l00081"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#p1">00081</a> <font class="keyword">const</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> SBWRPC::disconnectMessage = -1;
00082 
<a name="l00084"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#q0">00084</a> <font class="keyword">const</font> <font class="keywordtype">char</font> *SBWRPC::brokerJar = <font class="stringliteral">"SBWBroker.jar"</font>;
00085 
<a name="l00089"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a0">00089</a> SBWRPC::SBWRPC(SBWRPCListener *l) : listener(l), receiver(new DoNothingReceiver()), inCallsMutex("inCalls"), outCallsMutex("outCalls")
00090 {
00091 }
00092 
<a name="l00096"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a1">00096</a> SBWRPC::~SBWRPC()
00097 {
00098         <font class="keyword">delete</font> receiver ;
00099 }
00100 
<a name="l00105"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a15">00105</a> <font class="keywordtype">void</font> SBWRPC::setListener(SBWRPCListener *x)
00106 {
00107         listener = x;
00108 }
00109 
<a name="l00118"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">00118</a> DataBlockReader SBWRPC::call(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> moduleTo, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> service, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> method, DataBlockWriter args)
00119 {
00120         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> messageId = - 1;
00121         RPCOutCall *<a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> ;
00122 
00123         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Creating new RPCOutCall to module "</font> &lt;&lt; moduleTo);
00124         <font class="keywordflow">try</font>
00125         {
00126                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> = <font class="keyword">new</font> RPCOutCall();
00127                 
00128                 {
00129                         SBWOSMutexLock ml(outCallsMutex);
00130                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> mId = 0 ;
00131 
00132                         <font class="keywordflow">while</font> ((Integer) outCalls.size() != mId &amp;&amp; outCalls[mId] != NULL)
00133                                 mId++;
00134 
00135                         <font class="keywordflow">if</font> ((Integer) outCalls.size() == mId)
00136                                 outCalls.resize(mId + 1, <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a>);
00137                         <font class="keywordflow">else</font>
00138                                 outCalls[mId] = <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> ;
00139 
00140                         messageId = mId ;
00141                 }
00142 
00143                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length ;
00144                 <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message = args.createCall(moduleTo, <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a16">getModuleId</a>(), messageId, service, method, length);
00145                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a11">transmit</a>(moduleTo, message, length);
00146 
00147                 DataBlockReader reader = <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a>-&gt;waitForReply(moduleTo);
00148                 SBWOSMutexLock ml(outCallsMutex);
00149 
00150                 <font class="keyword">delete</font> <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> ;
00151                 outCalls[messageId] = NULL ;
00152 
00153                 <font class="keywordflow">return</font> reader ;
00154         }
00155         <font class="keywordflow">catch</font> (SBWException *)
00156         {
00157                 <font class="keywordflow">if</font> (messageId != -1)
00158                 {
00159                         SBWOSMutexLock ml(outCallsMutex);
00160 
00161                         <font class="keyword">delete</font> <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> ;
00162                         outCalls[messageId] = NULL ;
00163                 }
00164 
00165                 <font class="keywordflow">throw</font> ;
00166         }
00167 }
00168 
<a name="l00174"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a8">00174</a> <font class="keywordtype">void</font> SBWRPC::receive(DataBlockReader reader)
00175 {
00176         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> type;
00177         
00178         reader.getWithoutType(type);
00179 
00180         <font class="keywordflow">switch</font> (type)
00181         {
00182                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a58a1">SBWSendCode</a> :
00183                         receiveCall(reader, <font class="keyword">false</font>);
00184                         <font class="keywordflow">break</font> ;
00185 
00186                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a58a2">SBWCallCode</a> :
00187                         receiveCall(reader, <font class="keyword">true</font>);
00188                         <font class="keywordflow">break</font> ;
00189 
00190                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a58a0">SBWReplyCode</a> :
00191                         receiveReply(reader, <font class="keyword">false</font>);
00192                         <font class="keywordflow">break</font> ;
00193 
00194                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a58a3">SBWExceptionCode</a> :
00195                         receiveReply(reader, <font class="keyword">true</font>);
00196                         <font class="keywordflow">break</font> ;
00197 
00198                 <font class="keywordflow">default</font> :
00199                         SBWException::log(
00200                                 <font class="stringliteral">"Corrupted Message"</font>,
00201                                 <font class="stringliteral">"Error while decoding message, expecting message type in range 0-3, got value outside that range"</font>);
00202         }
00203 }
00204 
<a name="l00209"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a9">00209</a> <font class="keywordtype">void</font> SBWRPC::registerReceiver(Receiver *r)
00210 {
00211         <font class="keywordflow">if</font> (receiver-&gt;canDelete())
00212                 <font class="keyword">delete</font> receiver ;
00213 
00214         receiver = r ;
00215 }
00216 
<a name="l00224"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a10">00224</a> <font class="keywordtype">void</font> SBWRPC::send(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> moduleTo, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> service, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> method, DataBlockWriter args)
00225 {
00226         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Sending to module "</font> &lt;&lt; moduleTo);
00227 
00228         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length ;
00229         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message = args.createSend(moduleTo, <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a16">getModuleId</a>(), service, method, length);
00230 
00231         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a11">transmit</a>(moduleTo, message, length);
00232 }
00233 
<a name="l00240"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a11">00240</a> <font class="keywordtype">void</font> SBWRPC::transmit(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> moduleTo, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message, <font class="keywordtype">int</font> length)
00241 {
00242         <font class="keywordflow">if</font> (moduleTo == <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a16">getModuleId</a>())
00243         {
00244                 DataBlockReader reader(message, length, <font class="keyword">false</font>);
00245                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> i ;
00246 
00247                 reader.getWithoutType(i); <font class="comment">// length</font>
00248                 reader.getWithoutType(i); <font class="comment">// destination</font>
00249                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a8">receive</a>(reader); <font class="comment">// send to self</font>
00250         }
00251         <font class="keywordflow">else</font>
00252         {
00253                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#b1">transmitExternalOnly</a>(moduleTo, message, length);
00254         }
00255 }
00256 
<a name="l00261"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a12">00261</a> <font class="keywordtype">void</font> SBWRPC::onOtherModuleInstanceShutdown(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> otherModuleId)
00262 {
00263         {
00264                 SBWOSMutexLock ml(outCallsMutex);
00265                 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> outCallId = 0 ;
00266 
00267                 <font class="keywordflow">while</font> (outCalls.size() != outCallId)
00268                 {
00269                         RPCOutCall *outCall = outCalls[outCallId] ;
00270 
00271                         <font class="keywordflow">if</font> (outCall != NULL)
00272                                 outCall-&gt;onOtherModuleInstanceShutdown(otherModuleId);
00273 
00274                         outCallId++ ;
00275                 }
00276         }
00277 
00278         listener-&gt;onModuleShutdown(otherModuleId);
00279 }
00280 
<a name="l00285"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a13">00285</a> <font class="keywordtype">void</font> SBWRPC::onOtherModuleInstanceStartup(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> otherModuleId)
00286 {
00287         listener-&gt;onModuleStart(otherModuleId);
00288 }
00289 
<a name="l00293"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a14">00293</a> <font class="keywordtype">void</font> SBWRPC::onRegistrationChange()
00294 {
00295         listener-&gt;onRegistrationChange();
00296 }
00297 
<a name="l00302"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#b0">00302</a> <font class="keywordtype">void</font> SBWRPC::cleanup()
00303 {
00304         listener-&gt;onShutdown();
00305 
00306         {
00307                 SBWOSMutexLock ml(inCallsMutex);
00308                 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> thread = 0 ;
00309 
00310                 <font class="keywordflow">while</font> (inCalls.size() != thread)
00311                 {
00312                         inCalls[thread]-&gt;stop(); <font class="comment">// signal we want thread to stop</font>
00313                         <font class="comment">// was inCalls[thread]-&gt;join(); // wait for thread to stop</font>
00314                         inCalls[thread]-&gt;waitTillComplete(); <font class="comment">// wait for thread to stop</font>
00315                         <font class="keyword">delete</font> inCalls[thread] ; <font class="comment">// safely destroy thread object</font>
00316                         inCalls[thread] = NULL ;
00317                         thread++ ;
00318                 }
00319         }
00320 
00321         {
00322                 SBWOSMutexLock ml(outCallsMutex);
00323                 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> outCallId = 0 ;
00324 
00325                 <font class="keywordflow">while</font> (outCalls.size() != outCallId)
00326                 {
00327                         RPCOutCall *outCall = outCalls[outCallId];
00328 
00329                         <font class="keywordflow">if</font> (outCall != NULL)
00330                                 outCall-&gt;onBrokerShutdown();
00331                         
00332                         outCallId++ ;
00333                 }
00334         }
00335 }
00336 
00343 <font class="keywordtype">void</font> SBWRPC::receiveCall(DataBlockReader reader, <font class="keywordtype">bool</font> transmitReply)
00344 {
00345         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Receiving call/send message, transmitReply = "</font> &lt;&lt; transmitReply);
00346 
00347         RPCInCall *<a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> ;
00348         SBWOSMutexLock ml(inCallsMutex);
00349         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> thread = 0 ;
00350 
00351         <font class="keywordflow">while</font> (inCalls.size() != thread &amp;&amp; inCalls[thread] != NULL &amp;&amp; inCalls[thread]-&gt;isActive())
00352                 thread++ ;
00353 
00354         <font class="keywordflow">if</font> (inCalls.size() == thread || inCalls[thread] == NULL)
00355         {
00356                 <font class="keywordtype">char</font> buffer[20];
00357                 std::string name(<font class="stringliteral">"in call "</font>);
00358 
00359                 sprintf(buffer, <font class="stringliteral">"%d"</font>, thread);
00360 
00361                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> = <font class="keyword">new</font> RPCInCall(<font class="keyword">this</font>, receiver, name);
00362                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a>-&gt;createThread();
00363 
00364                 <font class="keywordflow">if</font> (inCalls.size() == thread)
00365                         inCalls.resize(thread + 1, <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a>);
00366                 <font class="keywordflow">else</font>
00367                         inCalls[thread] = <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> ;
00368         }
00369         <font class="keywordflow">else</font>
00370                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a> = inCalls[thread];
00371 
00372         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a2">call</a>-&gt;execute(reader, transmitReply);
00373 }
00374 
00381 <font class="keywordtype">void</font> SBWRPC::receiveReply(DataBlockReader reader, <font class="keywordtype">bool</font> isException)
00382 {
00383         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Receiving reply message, isException = "</font> &lt;&lt; isException);
00384 
00385         <font class="keywordtype">int</font> messageId;
00386                 
00387         reader.getWithoutType(messageId);
00388         outCalls[messageId]-&gt;processReply(reader, isException);
00389 }
</pre></div><hr>
<br>
<address>
<center>
<b>Systems Biology Workbench Development Group</b><br>
ERATO Kitano Systems Biology Project<br>
Control and Dynamical Systems, MC 107-81<br>
California Institute of Technology, Pasadena, CA 91125, USA<br>
<A HREF="mailto:sysbio-team@caltech.edu">sysbio-team@caltech.edu</A><br>
<A HREF="http://www.cds.caltech.edu/erato">http://www.cds.caltech.edu/erato</A><br><br>
<small>
Generated on Fri Nov 22 00:10:05 2002 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.2.14
</small>
</center>
</address>
</body>
</html>
