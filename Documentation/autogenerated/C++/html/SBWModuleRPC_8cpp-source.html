<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SBWModuleRPC.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>SBWModuleRPC.cpp</h1><a href="SBWModuleRPC_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00013 <font class="comment">/*</font>
00014 <font class="comment">** Copyright 2001 California Institute of Technology and</font>
00015 <font class="comment">** Japan Science and Technology Corporation.</font>
00016 <font class="comment">** </font>
00017 <font class="comment">** This library is free software; you can redistribute it and/or modify it</font>
00018 <font class="comment">** under the terms of the GNU Lesser General Public License as published</font>
00019 <font class="comment">** by the Free Software Foundation; either version 2.1 of the License, or</font>
00020 <font class="comment">** any later version.</font>
00021 <font class="comment">** </font>
00022 <font class="comment">** This library is distributed in the hope that it will be useful, but</font>
00023 <font class="comment">** WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF</font>
00024 <font class="comment">** MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  The software and</font>
00025 <font class="comment">** documentation provided hereunder is on an "as is" basis, and the</font>
00026 <font class="comment">** California Institute of Technology and Japan Science and Technology</font>
00027 <font class="comment">** Corporation have no obligations to provide maintenance, support,</font>
00028 <font class="comment">** updates, enhancements or modifications.  In no event shall the</font>
00029 <font class="comment">** California Institute of Technology or the Japan Science and Technology</font>
00030 <font class="comment">** Corporation be liable to any party for direct, indirect, special,</font>
00031 <font class="comment">** incidental or consequential damages, including lost profits, arising</font>
00032 <font class="comment">** out of the use of this software and its documentation, even if the</font>
00033 <font class="comment">** California Institute of Technology and/or Japan Science and Technology</font>
00034 <font class="comment">** Corporation have been advised of the possibility of such damage.  See</font>
00035 <font class="comment">** the GNU Lesser General Public License for more details.</font>
00036 <font class="comment">** </font>
00037 <font class="comment">** You should have received a copy of the GNU Lesser General Public License</font>
00038 <font class="comment">** along with this library; if not, write to the Free Software Foundation,</font>
00039 <font class="comment">** Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</font>
00040 <font class="comment">**</font>
00041 <font class="comment">** The original code contained here was initially developed by:</font>
00042 <font class="comment">**</font>
00043 <font class="comment">**     Andrew Finney, Herbert Sauro, Michael Hucka, Hamid Bolouri</font>
00044 <font class="comment">**     The Systems Biology Workbench Development Group</font>
00045 <font class="comment">**     ERATO Kitano Systems Biology Project</font>
00046 <font class="comment">**     Control and Dynamical Systems, MC 107-81</font>
00047 <font class="comment">**     California Institute of Technology</font>
00048 <font class="comment">**     Pasadena, CA, 91125, USA</font>
00049 <font class="comment">**</font>
00050 <font class="comment">**     http://www.cds.caltech.edu/erato</font>
00051 <font class="comment">**     mailto:sysbio-team@caltech.edu</font>
00052 <font class="comment">**</font>
00053 <font class="comment">** Contributor(s):</font>
00054 <font class="comment">**</font>
00055 <font class="comment">*/</font>
00056 
00057 <font class="comment">// SBWModuleRPC.cpp: implementation of the SBWModuleRPC class.</font>
00058 <font class="comment">//</font>
00060 <font class="comment"></font>
00061 <font class="preprocessor">#include "<a class="code" href="stdafx_8h.html">stdafx.h</a>"</font>
00062 <font class="preprocessor">#include "<a class="code" href="SBWModuleRPC_8h.html">SBWModuleRPC.h</a>"</font>
00063 
00064 <font class="preprocessor">#ifdef WIN32</font>
00065 <font class="preprocessor"></font><font class="preprocessor">#include &lt;io.h&gt;</font>
00066 <font class="preprocessor">#endif</font>
00067 <font class="preprocessor"></font>
00068 <font class="preprocessor">#include "<a class="code" href="SBWOSSocket_8h.html">SBWOSSocket.h</a>"</font>
00069 <font class="preprocessor">#include "<a class="code" href="SBWRawException_8h.html">SBWRawException.h</a>"</font>
00070 <font class="preprocessor">#include "<a class="code" href="DataBlockWriterClass_8h.html">DataBlockWriterClass.h</a>"</font>
00071 <font class="preprocessor">#include "<a class="code" href="SBWCommunicationException_8h.html">SBWCommunicationException.h</a>"</font>
00072 <font class="preprocessor">#include "<a class="code" href="DataBlockWriter_8h.html">DataBlockWriter.h</a>"</font>
00073 <font class="preprocessor">#include "<a class="code" href="SBWConfig_8h.html">SBWConfig.h</a>"</font>
00074 <font class="preprocessor">#include "<a class="code" href="SessionKey_8h.html">SessionKey.h</a>"</font>
00075 <font class="preprocessor">#include "<a class="code" href="RuntimeProperties_8h.html">RuntimeProperties.h</a>"</font>
00076 
00077 
00078 <font class="preprocessor">#include &lt;sys/stat.h&gt;</font>
00079 
00080 
00081 <font class="keyword">using</font> <font class="keyword">namespace </font>SystemsBiologyWorkbench ;
00082 
00084 <font class="comment">// Construction/Destruction</font>
00086 <font class="comment"></font>
<a name="l00091"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#a0">00091</a> <font class="comment"></font>SBWModuleRPC::SBWModuleRPC(SBWRPCListener *initialListener)
00092 : SBWRPC(initialListener), SBWThread("socket receive"), socket(NULL), state(Disconnected), transmitMutex("transmit")
00093 {
00094         <font class="comment">// At the point this is created, a new SBWThread is created</font>
00095         <font class="comment">// but it is not yet start()'ed.</font>
00096 }
00097 
<a name="l00099"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#a1">00099</a> SBWModuleRPC::~SBWModuleRPC()
00100 {
00101 }
00102 
<a name="l00107"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#a5">00107</a> <font class="keywordtype">bool</font> SBWModuleRPC::isConnected()
00108 {
00109         <font class="keywordflow">return</font> state == Connected ;
00110 }
00111 
<a name="l00121"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#a2">00121</a> <font class="keywordtype">void</font> SBWModuleRPC::connect(<font class="keyword">const</font> <font class="keywordtype">char</font> *moduleName, <font class="keyword">const</font> <font class="keywordtype">char</font> *hostname)
00122 {
00123         <font class="keywordflow">if</font> (state != Disconnected)
00124         {
00125                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Tried to connect, but already connected"</font>);
00126                 <font class="keywordflow">return</font>;
00127         }
00128 
00129         state = Connecting;
00130 
00131         SBWOSMutexLock ml(transmitMutex);
00132 
00133         <font class="keywordtype">int</font> port = RuntimeProperties::getSBWModulePort();
00134         <font class="keywordflow">if</font> (port &gt; 0)
00135         {
00136             <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Found sbw.module.port in runtime properties file"</font>);
00137             <font class="keywordflow">if</font> (SBWOSSocket::portInUse(port))
00138             {
00139                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Since port is in use, will assume Broker is running"</font>);
00140                         <font class="keywordflow">if</font> (connectToBroker(moduleName, hostname, port))
00141                                 state = Connected;
00142                         <font class="keywordflow">else</font>
00143                         {
00144                                 state = Disconnected;
00145                                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWCommunicationException(
00146                                 <font class="stringliteral">"Unable to connect to the SBW Broker"</font>,
00147                                 <font class="stringliteral">"The SBW Broker appears to be running, based on"</font>
00148                                 <font class="stringliteral">" the fact that the runtime properties file contains"</font>
00149                                 <font class="stringliteral">" a port number and that port is in use.  However,"</font>
00150                                 <font class="stringliteral">" the client library was unable to connect to the"</font>
00151                                 <font class="stringliteral">" Broker"</font>);
00152                         }
00153             }
00154             <font class="keywordflow">else</font>
00155                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"sbw.module.port is not in use"</font>);
00156         }
00157 
00158         <font class="keywordflow">if</font> (state != Connected)
00159         {
00160                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Broker does not appear to be running"</font>);
00161                 port = startBroker();
00162 
00163                 <font class="comment">// 2002-05-31 There's some weird timing bug we don't</font>
00164                 <font class="comment">// understand, but re-reading the file here seems to</font>
00165                 <font class="comment">// work around it.  FIXME.</font>
00166 
00167                 port = RuntimeProperties::getSBWModulePort();
00168 
00169                 <font class="keywordflow">if</font> (port &lt;= 0)
00170                 {
00171                         state = Disconnected ;
00172                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWCommunicationException(
00173                         <font class="stringliteral">"Unable to start the SBW Broker"</font>,
00174                         <font class="stringliteral">"The SBW Broker was not running and the"</font>
00175                         <font class="stringliteral">" client library could not start it up."</font>);
00176                 }
00177 
00178                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> attempts = 120;
00179 
00180                 <font class="keywordflow">while</font> (attempts != 0 &amp;&amp; !connectToBroker(moduleName, hostname, port))
00181                 {
00182                         SBWThread::sleep(1000); 
00183                     attempts--;
00184                 }
00185 
00186                 <font class="keywordflow">if</font> (state != Connected)
00187                 {
00188                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWCommunicationException(
00189                         <font class="stringliteral">"Unable to connect to the SBW Broker"</font>,
00190                         <font class="stringliteral">"The client library appears to have"</font>
00191                         <font class="stringliteral">" successfully started up the SBW Broker,"</font>
00192                         <font class="stringliteral">" but it was then unable to connect to the"</font>
00193                         <font class="stringliteral">" Broker."</font>);
00194                 }
00195         }
00196 
00197         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Successfully connected to Broker as module "</font> &lt;&lt; moduleId);
00198         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a2">start</a>();
00199         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Started message thread; ending connect phase"</font>);
00200 }
00201 
00202 
00206 <font class="keywordtype">int</font> SBWModuleRPC::startBroker()
00207 {
00208         std::string commandLine;
00209 
00210 <font class="comment">/* Temporarily disabling the use of startbroker.bat under windows */</font>
00211 <font class="preprocessor">#ifndef WIN32</font>
00212 <font class="preprocessor"></font>        <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Will first try starting Broker with startup script"</font>);
00213 
00214         std::string brokerStartupScript = Config::getSBWHome();
00215         brokerStartupScript += SBWOS::DirectorySeparator();
00216         brokerStartupScript += <font class="stringliteral">"bin"</font>;
00217         brokerStartupScript += SBWOS::DirectorySeparator();
00218 <font class="preprocessor">#ifdef WIN32</font>
00219 <font class="preprocessor"></font>        brokerStartupScript += <font class="stringliteral">"startbroker.bat"</font>;
00220 <font class="preprocessor">#else</font>
00221 <font class="preprocessor"></font>        brokerStartupScript += <font class="stringliteral">"startbroker"</font>;
00222 <font class="preprocessor">#endif</font>
00223 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (fileExists(brokerStartupScript.c_str()))
00224         {
00225             <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Startup script is "</font> &lt;&lt; brokerStartupScript);
00226             commandLine = brokerStartupScript;
00227         }
00228         <font class="keywordflow">else</font>
00229 <font class="preprocessor">#endif</font>
00230 <font class="preprocessor"></font>        {
00231             <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Cannot find Broker startup script; trying Broker JAR file"</font>);
00232 
00233             std::string jarPath = Config::getLibDirectory();
00234             jarPath += SBWOS::DirectorySeparator();
00235             jarPath += <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#q0">brokerJar</a>;       <font class="comment">// From SBWRPC.cpp</font>
00236 
00237             <font class="comment">// Check if the jar files are where we expect them.</font>
00238             
00239             <font class="keywordflow">if</font> (! fileExists(jarPath.c_str()))
00240             {
00241                     std::string message(<font class="stringliteral">"SBW Installation corrupted: "</font>);
00242                     message += jarPath;
00243                     message += <font class="stringliteral">" is not present.  This file is required to"</font>
00244                         <font class="stringliteral">" launch the SBW Broker."</font>;
00245                     <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWRawException(message.c_str());
00246             }
00247             <font class="keywordflow">else</font>
00248             {
00249 <font class="preprocessor">#ifdef WIN32</font>
00250 <font class="preprocessor"></font>                    std::string jarCmd(<font class="stringliteral">"javaw -jar \""</font>);
00251 <font class="preprocessor">#else</font>
00252 <font class="preprocessor"></font>                    std::string jarCmd(<font class="stringliteral">"java -jar \""</font>);
00253 <font class="preprocessor">#endif</font>
00254 <font class="preprocessor"></font>                    commandLine += jarCmd;
00255                     commandLine += jarPath;
00256                     commandLine += <font class="charliteral">'\"'</font>;
00257             }
00258         }           
00259 
00260         std::string file = RuntimeProperties::getPropertiesFile();
00261         time_t time;
00262         <font class="keyword">struct </font>stat statbuff;
00263 
00264         <font class="keywordflow">if</font> (stat(file.c_str(), &amp;statbuff) == 0)
00265                 time = statbuff.st_mtime;
00266         <font class="keywordflow">else</font>
00267                 time = 0;
00268 
00269         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"original stat time = "</font> &lt;&lt; time);
00270 
00271         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Attempting to start Broker using command: "</font> &lt;&lt; commandLine.c_str());
00272 
00273         SBWOS::startProcess((<font class="keywordtype">char</font> *)commandLine.c_str());
00274 
00275         <font class="keywordtype">int</font> attempts = 25;
00276         <font class="keywordtype">int</font> port = -1;
00277         
00278         <font class="keywordflow">try</font>
00279         {
00280                 <font class="keywordflow">while</font> (attempts != 0 &amp;&amp; port &lt; 0)
00281                 {
00282                         SBWThread::sleep(200);
00283                         <font class="keywordflow">if</font> (stat(file.c_str(), &amp;statbuff) == 0)
00284                         {
00285                                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"stat = "</font> &lt;&lt; statbuff.st_mtime);
00286                                 <font class="keywordflow">if</font> (time &lt; statbuff.st_mtime
00287                                     &amp;&amp; (port = RuntimeProperties::getSBWModulePort()) &gt; 0)
00288                                     <font class="keywordflow">return</font> port;
00289                         }
00290                         attempts--;
00291                 }
00292 
00293                 <font class="keywordflow">if</font> ((port = RuntimeProperties::getSBWModulePort()) &gt; 0)
00294                         <font class="keywordflow">return</font> port;
00295                 <font class="keywordflow">else</font> 
00296                         state = Disconnected;
00297         }
00298         <font class="keywordflow">catch</font> (SBWException *)
00299         {
00300                 <font class="keywordflow">try</font>
00301                 {
00302                         <font class="keyword">delete</font> socket ;
00303                 }
00304                 <font class="keywordflow">catch</font> (SBWException *)
00305                 {
00306                         <font class="comment">// delibrately ignored - don't know or care if we have good connection</font>
00307                 }
00308                 state = Disconnected;
00309                 <font class="keywordflow">throw</font>;
00310         }
00311         <font class="keywordflow">return</font> -1;
00312 }
00313 
00314 
00315 <font class="keywordtype">bool</font> SBWModuleRPC::fileExists(<font class="keyword">const</font> <font class="keywordtype">char</font> *path)
00316 {
00317 <font class="preprocessor">#ifdef LINUX</font>
00318 <font class="preprocessor"></font>        <font class="keyword">struct </font>stat statbuff;
00319 <font class="preprocessor">#endif</font>
00320 <font class="preprocessor"></font><font class="preprocessor">#ifdef WIN32</font>
00321 <font class="preprocessor"></font>        <font class="keywordflow">return</font> access(path, 0 ) != -1;
00322 <font class="preprocessor">#else</font>
00323 <font class="preprocessor"></font>        <font class="comment">// printf("Stat'ing %s\n", jarFile.c_str());</font>
00324         <font class="keywordflow">return</font> stat(path, &amp;statbuff) != -1;
00325 <font class="preprocessor">#endif</font>
00326 <font class="preprocessor"></font>}
00327 
00328 
00329 <font class="keywordtype">bool</font> SBWModuleRPC::connectToBroker(<font class="keyword">const</font> <font class="keywordtype">char</font> *moduleName,
00330                                    <font class="keyword">const</font> <font class="keywordtype">char</font> *hostname, <font class="keywordtype">int</font> port)
00331 {
00332     <font class="keywordflow">if</font> (hostname == NULL || strlen(hostname) == 0)
00333     {
00334                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Trying to connect to Broker on localhost port "</font> &lt;&lt; port);
00335     }
00336     <font class="keywordflow">else</font>
00337     {
00338                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Trying to connect to Broker on host "</font> &lt;&lt; hostname
00339                           &lt;&lt; <font class="stringliteral">", port "</font> &lt;&lt; port);
00340     }
00341 
00342     <font class="keywordflow">try</font>
00343     {
00344                 socket = <font class="keyword">new</font> SBWOSSocket(port, hostname);
00345                 connectMessageStreams(moduleName);
00346                 state = Connected;
00347                 <font class="keywordflow">return</font> <font class="keyword">true</font>;
00348     }
00349     <font class="keywordflow">catch</font> (SBWConnectException *e)
00350     {
00351                 state = Disconnected ;
00352 <font class="preprocessor">#ifdef DEBUG</font>
00353 <font class="preprocessor"></font>                e-&gt;log();
00354 <font class="preprocessor">#endif</font>
00355 <font class="preprocessor"></font>                <font class="keyword">delete</font> e;
00356     }
00357     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00358 }
00359 
00360 
00361 <font class="keywordtype">void</font> SBWModuleRPC::connectMessageStreams(<font class="keyword">const</font> <font class="keywordtype">char</font> *moduleName)
00362 {
00363     <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Trying to connect message streams"</font>);
00364     <font class="keywordflow">try</font>
00365     {
00366                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length;
00367                 <font class="keyword">const</font> <font class="keywordtype">char</font> *key = SessionKey::getKey().c_str();
00368                 <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message
00369                         = DataBlockWriter::createConnectMessage(key, moduleName, length);
00370                 
00371                 socket-&gt;transmit(message, length);
00372                 <font class="keyword">delete</font>[] message;
00373 
00374                 moduleId = sbwDataBlockReader::readInteger(socket);
00375                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Successfully connected message streams"</font>);
00376     }
00377     <font class="keywordflow">catch</font> (SBWConnectException *)
00378     {
00379                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Could not connect message streams; disconnecting"</font>);
00380                 <font class="keywordflow">try</font>
00381                 {
00382                         <font class="keyword">delete</font> socket;
00383                 }
00384                 <font class="keywordflow">catch</font> (SBWException *)
00385                 {
00386                         <font class="comment">// delibrately ignored - don't know or care if we have good connection</font>
00387                 }
00388                 state = Disconnected;
00389                 <font class="keywordflow">throw</font>;
00390     }
00391 }
00392 
<a name="l00397"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#a4">00397</a> <font class="keywordtype">void</font> SBWModuleRPC::signalDisconnect()
00398 {
00399         <font class="keywordflow">if</font> (state == Connected || state == Connecting)
00400         {
00401                 <font class="keywordflow">try</font>
00402                 {
00403                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length ;
00404                         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message = DataBlockWriter::createDisconnectMessage(length);
00405 
00406                         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a11">transmit</a>(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a64a49">SBWBrokerModule</a>, message, length);
00407                 }
00408                 <font class="keywordflow">catch</font> (SBWException *e)
00409                 {
00410                         <font class="keyword">delete</font> e ; <font class="comment">// don't care if we've already disconnected!!</font>
00411                 }
00412 
00413                 state = Disconnecting ;
00414         }
00415 }
00416 
<a name="l00420"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#a6">00420</a> <font class="keywordtype">void</font> SBWModuleRPC::waitForDisconnect()
00421 {
00422         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"rejoining thread"</font>);
00423         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a4">join</a>();
00424 }
00425 
<a name="l00430"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#b0">00430</a> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> SBWModuleRPC::getModuleId()
00431 {
00432         <font class="keywordflow">if</font> (state != Connected)
00433                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWCommunicationException(<font class="stringliteral">"application has no module id when not connected"</font>);
00434 
00435         <font class="keywordflow">return</font> moduleId;
00436 }
00437 
<a name="l00445"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWModuleRPC.html#b1">00445</a> <font class="keywordtype">void</font> SBWModuleRPC::transmitExternalOnly(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> destinationModuleId, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length)
00446 {
00447         <font class="keywordflow">try</font>
00448         {
00449                 SBWOSMutexLock ml(transmitMutex);
00450 
00451                 <font class="keywordflow">if</font> (state == Disconnected)
00452                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWCommunicationException(<font class="stringliteral">"attempting to transmit when not connected"</font>);
00453 
00454                 socket-&gt;transmit(message, length);
00455                 <font class="keyword">delete</font>[] message ;
00456         }
00457         <font class="keywordflow">catch</font> (SBWDisconnectException *e)
00458         {
00459                 state = Disconnecting ;
00460                 <font class="keyword">delete</font> e ;
00461                 <font class="keyword">delete</font>[] message ;
00462                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWCommunicationException(<font class="stringliteral">"broker disconnected"</font>);
00463         }
00464         <font class="keywordflow">catch</font> (SBWException *)
00465         {
00466                 <font class="keyword">delete</font>[] message ; <font class="comment">// just because C++ has no finally!</font>
00467                 <font class="keywordflow">throw</font> ;
00468         }
00469 }
00470 
00476 <font class="keywordtype">void</font> SBWModuleRPC::run()
00477 {
00478         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Receiver thread started"</font>);
00479 
00480         <font class="keywordflow">while</font> (state == Connected)
00481         {
00482                 <font class="keywordflow">try</font>
00483                 {
00484                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Waiting on socket for new message"</font>);
00485 
00486                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length = sbwDataBlockReader::readInteger(socket);
00487                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> toModuleId = sbwDataBlockReader::readInteger(socket);
00488 
00489                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"New message received"</font>);
00490 
00491                         <font class="keywordflow">if</font> (toModuleId == moduleId)
00492                         {
00493                                 length -= 8;
00494                                 <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *raw = <font class="keyword">new</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>[length];
00495                                 
00496                                 socket-&gt;receive(raw, length);
00497                                 <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#a8">receive</a>(DataBlockReader(raw, length, <font class="keyword">false</font>));  <font class="comment">// don't duplicate/copy raw data</font>
00498                         }
00499                         <font class="keywordflow">else</font>
00500                                 SBWException::log(<font class="stringliteral">"received message for different module"</font>);
00501                 }
00502                 <font class="keywordflow">catch</font> (SBWDisconnectException *e)
00503                 {
00504                         <font class="keyword">delete</font> e ;
00505                         state = Disconnecting ;
00506                 }
00507                 <font class="keywordflow">catch</font> (SBWException *e)
00508                 {
00509                         e-&gt;log();
00510                         <font class="keyword">delete</font> e;
00511                 }
00512         }
00513 
00514         {
00515                 SBWOSMutexLock ml(transmitMutex);
00516                 <font class="keyword">delete</font> socket ;
00517         }
00518 
00519         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWRPC.html#b0">cleanup</a>();
00520         state = Disconnected ;
00521 }
</pre></div><hr>
<br>
<address>
<center>
<b>Systems Biology Workbench Development Group</b><br>
ERATO Kitano Systems Biology Project<br>
Control and Dynamical Systems, MC 107-81<br>
California Institute of Technology, Pasadena, CA 91125, USA<br>
<A HREF="mailto:sysbio-team@caltech.edu">sysbio-team@caltech.edu</A><br>
<A HREF="http://www.cds.caltech.edu/erato">http://www.cds.caltech.edu/erato</A><br><br>
<small>
Generated on Fri Nov 22 00:10:05 2002 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.2.14
</small>
</center>
</address>
</body>
</html>
