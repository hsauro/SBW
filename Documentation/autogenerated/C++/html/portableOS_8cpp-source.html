<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>portableOS.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>portableOS.cpp</h1><a href="portableOS_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00013 <font class="comment">/*</font>
00014 <font class="comment">** Copyright 2001 California Institute of Technology and</font>
00015 <font class="comment">** Japan Science and Technology Corporation.</font>
00016 <font class="comment">** </font>
00017 <font class="comment">** This library is free software; you can redistribute it and/or modify it</font>
00018 <font class="comment">** under the terms of the GNU Lesser General Public License as published</font>
00019 <font class="comment">** by the Free Software Foundation; either version 2.1 of the License, or</font>
00020 <font class="comment">** any later version.</font>
00021 <font class="comment">** </font>
00022 <font class="comment">** This library is distributed in the hope that it will be useful, but</font>
00023 <font class="comment">** WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF</font>
00024 <font class="comment">** MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  The software and</font>
00025 <font class="comment">** documentation provided hereunder is on an "as is" basis, and the</font>
00026 <font class="comment">** California Institute of Technology and Japan Science and Technology</font>
00027 <font class="comment">** Corporation have no obligations to provide maintenance, support,</font>
00028 <font class="comment">** updates, enhancements or modifications.  In no event shall the</font>
00029 <font class="comment">** California Institute of Technology or the Japan Science and Technology</font>
00030 <font class="comment">** Corporation be liable to any party for direct, indirect, special,</font>
00031 <font class="comment">** incidental or consequential damages, including lost profits, arising</font>
00032 <font class="comment">** out of the use of this software and its documentation, even if the</font>
00033 <font class="comment">** California Institute of Technology and/or Japan Science and Technology</font>
00034 <font class="comment">** Corporation have been advised of the possibility of such damage.  See</font>
00035 <font class="comment">** the GNU Lesser General Public License for more details.</font>
00036 <font class="comment">** </font>
00037 <font class="comment">** You should have received a copy of the GNU Lesser General Public License</font>
00038 <font class="comment">** along with this library; if not, write to the Free Software Foundation,</font>
00039 <font class="comment">** Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</font>
00040 <font class="comment">**</font>
00041 <font class="comment">** The original code contained here was initially developed by:</font>
00042 <font class="comment">**</font>
00043 <font class="comment">**     Andrew Finney, Herbert Sauro, Michael Hucka, Hamid Bolouri</font>
00044 <font class="comment">**     The Systems Biology Workbench Development Group</font>
00045 <font class="comment">**     ERATO Kitano Systems Biology Project</font>
00046 <font class="comment">**     Control and Dynamical Systems, MC 107-81</font>
00047 <font class="comment">**     California Institute of Technology</font>
00048 <font class="comment">**     Pasadena, CA, 91125, USA</font>
00049 <font class="comment">**</font>
00050 <font class="comment">**     http://www.cds.caltech.edu/erato</font>
00051 <font class="comment">**     mailto:sysbio-team@caltech.edu</font>
00052 <font class="comment">**</font>
00053 <font class="comment">** Contributor(s):</font>
00054 <font class="comment">**</font>
00055 <font class="comment">*/</font>
00056 
00057 <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">char</font> rcsid[] = <font class="stringliteral">"$Id: portableOS_8cpp-source.html,v 1.1 2002/11/22 08:14:57 mhucka Exp $"</font>;
00058 
00059 <font class="preprocessor">#include "<a class="code" href="stdafx_8h.html">stdafx.h</a>"</font>
00060 <font class="preprocessor">#include "<a class="code" href="SBWRawException_8h.html">SBWRawException.h</a>"</font>
00061 <font class="preprocessor">#include &lt;list&gt;</font>
00062 <font class="preprocessor">#include "<a class="code" href="SBWApplicationException_8h.html">SBWApplicationException.h</a>"</font>
00063 
00064 <font class="preprocessor">#ifndef WIN32</font>
00065 <font class="preprocessor"></font><font class="preprocessor">#include &lt;stdio.h&gt;</font>
00066 
00067 <font class="preprocessor">#ifdef HAVE_SYS_TIME_H</font>
00068 <font class="preprocessor"></font><font class="preprocessor">#include &lt;sys/time.h&gt;</font>
00069 <font class="preprocessor">#endif</font>
00070 <font class="preprocessor"></font>
00071 <font class="preprocessor">#ifdef HAVE_SYS_ERRNO_H</font>
00072 <font class="preprocessor"></font><font class="preprocessor">#include &lt;sys/errno.h&gt;</font>
00073 <font class="preprocessor">#endif</font>
00074 <font class="preprocessor"></font>
00075 <font class="preprocessor">#ifdef HAVE_UNISTD_H</font>
00076 <font class="preprocessor"></font><font class="preprocessor">#include &lt;unistd.h&gt;</font>
00077 <font class="preprocessor">#endif</font>
00078 <font class="preprocessor"></font>
00079 <font class="preprocessor">#endif</font>
00080 <font class="preprocessor"></font>
00081 <font class="keyword">using</font> <font class="keyword">namespace </font>SystemsBiologyWorkbench ;
00082 
00083 <font class="comment">// -----------------------------------------------------------------------------</font>
00084 <font class="comment">// Class SBWOS</font>
00085 <font class="comment">// -----------------------------------------------------------------------------</font>
00086 
<a name="l00093"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOS.html#d1">00093</a> <font class="keywordtype">void</font> SBWOS::ThrowError()
00094 {
00095 <font class="preprocessor">#if defined(WIN32)</font>
00096 <font class="preprocessor"></font>
00097         <font class="keywordtype">char</font> *lpMsgBuf ;
00098 
00099         DWORD error = ::GetLastError();
00100         
00101         <font class="keywordflow">if</font> (!::FormatMessage(
00102                         FORMAT_MESSAGE_ALLOCATE_BUFFER | 
00103                         FORMAT_MESSAGE_FROM_SYSTEM ,
00104                         NULL,
00105                         error,
00106                         MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), <font class="comment">// Default language</font>
00107                         (LPTSTR) &amp;lpMsgBuf,
00108                         0,
00109                         NULL ))
00110                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWRawException(<font class="stringliteral">"Unknown OS error"</font>);
00111                 
00112         SBWRawException *exception = <font class="keyword">new</font> SBWRawException((LPCTSTR) lpMsgBuf);
00113 
00114         <font class="comment">// Free the buffer.</font>
00115         LocalFree( lpMsgBuf );
00116 
00117 <font class="preprocessor">#elif defined(HAVE_SYS_ERRNO_H)</font>
00118 <font class="preprocessor"></font>
00119         <font class="comment">// FIXME need to localize the error message.</font>
00120         SBWRawException *exception = <font class="keyword">new</font> SBWRawException(strerror(errno));
00121 
00122 <font class="preprocessor">#endif</font>
00123 <font class="preprocessor"></font>
00124         <font class="keywordflow">throw</font> exception;
00125 }
00126 
<a name="l00133"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOS.html#d2">00133</a> <font class="keywordtype">void</font> SBWOS::ThrowError(<font class="keywordtype">int</font> error)
00134 {
00135 <font class="preprocessor">#if defined(WIN32)</font>
00136 <font class="preprocessor"></font>
00137         <font class="keywordtype">char</font> *lpMsgBuf ;
00138 
00139         <font class="keywordflow">if</font> (!::FormatMessage(
00140                         FORMAT_MESSAGE_ALLOCATE_BUFFER | 
00141                         FORMAT_MESSAGE_FROM_SYSTEM ,
00142                         NULL,
00143                         error,
00144                         MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), <font class="comment">// Default language</font>
00145                         (LPTSTR) &amp;lpMsgBuf,
00146                         0,
00147                         NULL ))
00148                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWRawException(<font class="stringliteral">"Unknown OS error"</font>);
00149                 
00150         SBWRawException *exception = <font class="keyword">new</font> SBWRawException((LPCTSTR) lpMsgBuf);
00151 
00152         <font class="comment">// Free the buffer.</font>
00153         LocalFree( lpMsgBuf );
00154 
00155 <font class="preprocessor">#elif defined(HAVE_SYS_ERRNO_H)</font>
00156 <font class="preprocessor"></font>
00157         <font class="comment">// FIXME need to localize the error message.</font>
00158         SBWRawException *exception;
00159         <font class="keywordflow">if</font> (error &gt; 0 &amp;&amp; error &lt; sys_nerr)
00160                 exception = <font class="keyword">new</font> SBWRawException(strerror(error));
00161         <font class="keywordflow">else</font> 
00162                 exception = <font class="keyword">new</font> SBWRawException(<font class="stringliteral">"Unknown OS error"</font>);
00163 
00164 <font class="preprocessor">#endif</font>
00165 <font class="preprocessor"></font>
00166         <font class="keywordflow">throw</font> exception;
00167 }
00168 
00169 
<a name="l00174"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOS.html#d0">00174</a> <font class="keywordtype">void</font> SBWOS::startProcess(<font class="keywordtype">char</font> *commandLine)
00175 {
00176     <font class="keywordflow">if</font> (commandLine == NULL)
00177         <font class="keywordflow">return</font>;
00178 
00179 <font class="preprocessor">#if defined(WIN32)</font>
00180 <font class="preprocessor"></font>
00181     STARTUPINFO si;
00182     memset(&amp;si,0,<font class="keyword">sizeof</font>(si));
00183     si.cb = <font class="keyword">sizeof</font>(si);     <font class="comment">// Set byte count</font>
00184 
00185     PROCESS_INFORMATION pi;
00186 
00187     <font class="keywordflow">if</font>(!CreateProcess(NULL, (LPTSTR) (LPCTSTR) commandLine,
00188                       NULL,NULL,FALSE,0,NULL,NULL,&amp;si,&amp;pi))
00189         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWOS.html#d1">ThrowError</a>();
00190 
00191 <font class="preprocessor">#else</font>
00192 <font class="preprocessor"></font>
00193     <font class="keywordtype">int</font> pid = fork();
00194 
00195     <font class="keywordflow">if</font> (pid == -1)                      <font class="comment">// Fork failed.</font>
00196         <a class="code" href="classSystemsBiologyWorkbench_1_1SBWOS.html#d1">ThrowError</a>();
00197 
00198     <font class="keywordflow">if</font> (pid == 0)                       <font class="comment">// This is the child process.</font>
00199     {
00200         <font class="keywordtype">char</font> *argv[4];
00201 
00202         argv[0] = <font class="stringliteral">"sh"</font>;
00203         argv[1] = <font class="stringliteral">"-c"</font>;
00204         argv[2] = commandLine;
00205         argv[3] = NULL;
00206         
00207         <font class="keywordflow">if</font> (execvp(<font class="stringliteral">"/bin/sh"</font>, argv) &gt; -1) <font class="comment">// Only returns on failure.</font>
00208             <a class="code" href="classSystemsBiologyWorkbench_1_1SBWOS.html#d1">ThrowError</a>();
00209     }
00210 
00211     <font class="comment">// If pid != -1 or 0, then we're the parent thread.</font>
00212     <font class="comment">// Simply exit and hope the child process started.</font>
00213 
00214 <font class="preprocessor">#endif</font>
00215 <font class="preprocessor"></font>}
00216 
00217 <font class="preprocessor">#ifdef WIN32</font>
00218 <font class="preprocessor"></font>
00223 <a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> <font class="keywordtype">void</font> SBWOS::windowsExtractCommandLine(<font class="keywordtype">int</font> *argc, <font class="keywordtype">char</font> ***argv)
00224 {
00225         <font class="keyword">static</font> <font class="keywordtype">char</font> *cmdLine = NULL;
00226         <font class="keyword">static</font> std::list&lt;char *&gt; args ;
00227         
00228         <font class="keywordflow">if</font> (cmdLine == NULL)
00229         {
00230                 <font class="keywordtype">char</font> *token;
00231                 
00232                 cmdLine = strdup(GetCommandLine());
00233 
00234                 <font class="comment">//MessageBox(NULL, cmdLine, "Trig - cmdline", MB_OK | MB_ICONEXCLAMATION);</font>
00235                 <font class="keywordflow">if</font> (cmdLine[0] == <font class="charliteral">'"'</font>)
00236                 {
00237                         cmdLine++;
00238 
00239                         <font class="keywordtype">int</font> index = strcspn(cmdLine, <font class="stringliteral">"\""</font>);
00240 
00241                         cmdLine[index] = <font class="charliteral">'\0'</font> ;
00242                         args.push_back(cmdLine);
00243                         token = strtok(&amp;(cmdLine[index + 1]), <font class="stringliteral">" \t\n"</font>);
00244                 }
00245                 <font class="keywordflow">else</font>
00246                         token = strtok(cmdLine, <font class="stringliteral">" \t\n"</font>);
00247 
00248                 <font class="keywordflow">while</font> (token != NULL)
00249                 {
00250                         args.push_back(token);
00251                         token = strtok(NULL, <font class="stringliteral">" \t\n"</font>);
00252                 }
00253         }
00254 
00255         *argc = args.size();
00256         *argv = <font class="keyword">new</font> <font class="keywordtype">char</font> *[*argc];
00257 
00258         <font class="keywordtype">int</font> i = 0 ;
00259         std::list&lt;char *&gt;::iterator arg = args.begin();
00260 
00261         <font class="keywordflow">while</font> (i != *argc)
00262         {
00263                 (*argv)[i] = *arg ;
00264                 i++ ;
00265                 arg++ ;
00266         }
00267 }
00268 <font class="preprocessor">#endif // WIN32</font>
00269 <font class="preprocessor"></font>
00270 <font class="comment">// -----------------------------------------------------------------------------</font>
00271 <font class="comment">// Class SBWOSMutex</font>
00272 <font class="comment">// -----------------------------------------------------------------------------</font>
00273 
<a name="l00278"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSMutex.html#a0">00278</a> <a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> SBWOSMutex::SBWOSMutex(std::string n) : name(n)
00279 {
00280 <font class="preprocessor">#if defined(WIN32)</font>
00281 <font class="preprocessor"></font>
00282         InitializeCriticalSection(&amp;criticalSection);
00283 
00284 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00285 <font class="preprocessor"></font>
00286         pthread_mutexattr_t attr;
00287         <font class="keywordtype">int</font> status;
00288 
00289         <font class="comment">// The default kind of mutex in Linux pthreads is "fast" mutexes,</font>
00290         <font class="comment">// not the "recursive" kind that is the default under Windows.</font>
00291         <font class="comment">// Here we set up the Linux pthread mutexes to be "recursive".</font>
00292 
00293         <font class="keywordflow">if</font> ((status = pthread_mutexattr_init(&amp;attr)) != 0)
00294                 SBWOS::ThrowError(status);
00295 
00296         <font class="keywordflow">if</font> ((status
00297                  = pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE_NP)) != 0)
00298                 SBWOS::ThrowError(status);
00299 
00300         <font class="keywordflow">if</font> ((status = pthread_mutex_init(&amp;mutex, &amp;attr)) != 0)
00301                 SBWOS::ThrowError(status);
00302 
00303         <font class="keywordflow">if</font> ((status = pthread_mutexattr_destroy(&amp;attr)) != 0)
00304                 SBWOS::ThrowError(status);
00305 
00306 <font class="preprocessor">#endif</font>
00307 <font class="preprocessor"></font>}
00308 
00309 <font class="comment">// FIXME make inline</font>
00310 <font class="comment">// FIXME bring common code together with version above</font>
<a name="l00316"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSMutex.html#a1">00316</a> <font class="comment"></font><a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> SBWOSMutex::SBWOSMutex(std::string n, std::string suffix) : name(n)
00317 {
00318         name += suffix ;
00319 
00320 <font class="preprocessor">#if defined(WIN32)</font>
00321 <font class="preprocessor"></font>
00322         InitializeCriticalSection(&amp;criticalSection);
00323 
00324 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00325 <font class="preprocessor"></font>
00326         pthread_mutexattr_t attr;
00327         <font class="keywordtype">int</font> status;
00328 
00329         <font class="comment">// The default kind of mutex in Linux pthreads is "fast" mutexes,</font>
00330         <font class="comment">// not the "recursive" kind that is the default under Windows.</font>
00331         <font class="comment">// Here we set up the Linux pthread mutexes to be "recursive".</font>
00332 
00333         <font class="keywordflow">if</font> ((status = pthread_mutexattr_init(&amp;attr)) != 0)
00334                 SBWOS::ThrowError(status);
00335 
00336         <font class="keywordflow">if</font> ((status
00337                  = pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE_NP)) != 0)
00338                 SBWOS::ThrowError(status);
00339 
00340         <font class="keywordflow">if</font> ((status = pthread_mutex_init(&amp;mutex, &amp;attr)) != 0)
00341                 SBWOS::ThrowError(status);
00342 
00343         <font class="keywordflow">if</font> ((status = pthread_mutexattr_destroy(&amp;attr)) != 0)
00344                 SBWOS::ThrowError(status);
00345 
00346 <font class="preprocessor">#endif</font>
00347 <font class="preprocessor"></font>}
00348 
<a name="l00352"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSMutex.html#a2">00352</a> SBWOSMutex::~SBWOSMutex()
00353 {
00354 <font class="preprocessor">#if defined(WIN32)</font>
00355 <font class="preprocessor"></font>
00356         DeleteCriticalSection(&amp;criticalSection);
00357 
00358 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00359 <font class="preprocessor"></font>
00360         <font class="keywordtype">int</font> status;
00361         
00362         <font class="keywordflow">if</font> ((status = pthread_mutex_destroy(&amp;mutex)) != 0)
00363                 SBWOS::ThrowError(status);
00364 
00365 <font class="preprocessor">#endif</font>
00366 <font class="preprocessor"></font>}
00367 
<a name="l00373"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSMutex.html#a3">00373</a> <font class="keywordtype">void</font> SBWOSMutex::lock()
00374 {
00375 <font class="preprocessor">#if defined(WIN32)</font>
00376 <font class="preprocessor"></font>
00377         EnterCriticalSection(&amp;criticalSection);
00378 
00379 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00380 <font class="preprocessor"></font>
00381         <font class="keywordtype">int</font> status;
00382 
00383         <font class="keywordflow">if</font> ((status = pthread_mutex_lock(&amp;mutex)) != 0)
00384                 SBWOS::ThrowError(status);
00385 
00386 <font class="preprocessor">#endif</font>
00387 <font class="preprocessor"></font>}
00388 
<a name="l00392"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSMutex.html#a4">00392</a> <font class="keywordtype">void</font> SBWOSMutex::unLock()
00393 {
00394 <font class="preprocessor">#if defined(WIN32)</font>
00395 <font class="preprocessor"></font>
00396         LeaveCriticalSection(&amp;criticalSection);
00397 
00398 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00399 <font class="preprocessor"></font>
00400         <font class="keywordtype">int</font> status;
00401 
00402         <font class="keywordflow">if</font> ((status = pthread_mutex_unlock(&amp;mutex)) != 0)
00403                 SBWOS::ThrowError(status);
00404 
00405 <font class="preprocessor">#endif</font>
00406 <font class="preprocessor"></font>}
00407 
00408 <font class="comment">// -----------------------------------------------------------------------------</font>
00409 <font class="comment">// Class SBWThread</font>
00410 <font class="comment">// -----------------------------------------------------------------------------</font>
00411 
<a name="l00416"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a0">00416</a> SBWThread::SBWThread(std::string n) : name(n), joined(false)
00417 {
00418 <font class="preprocessor">#if defined(WIN32)</font>
00419 <font class="preprocessor"></font>        thread = NULL;
00420 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00421 <font class="preprocessor"></font>        threadId = 0;
00422 <font class="preprocessor">#endif</font>
00423 <font class="preprocessor"></font>}
00424 
<a name="l00429"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a1">00429</a> SBWThread::~SBWThread()
00430 {
00431         <font class="keywordflow">if</font> (!joined)
00432         {
00433 <font class="preprocessor">#if defined(WIN32)</font>
00434 <font class="preprocessor"></font>                <font class="keywordflow">if</font> (thread != NULL)
00435 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00436 <font class="preprocessor"></font>                <font class="keywordflow">if</font> (threadId &gt; 0)
00437 <font class="preprocessor">#endif</font>
00438 <font class="preprocessor"></font>                {
00439                         <font class="keywordflow">throw</font> <font class="keyword">new</font>
00440                                 SBWRawException(<font class="stringliteral">"Attempting to delete running thread before join to thread has completed"</font>);
00441                 }
00442         }
00443 
00444 <font class="preprocessor">#if defined(WIN32)</font>
00445 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (thread != NULL &amp;&amp; !CloseHandle(thread))
00446                 SBWOS::ThrowError();
00447 <font class="preprocessor">#endif</font>
00448 <font class="preprocessor"></font>}
00449 
00455 <font class="preprocessor">#if defined(WIN32)</font>
00456 <font class="preprocessor"></font>DWORD WINAPI SBWThread::threadProc(<a class="code" href="portableOS_8h.html#a0">LPVOID</a> lpParameter)
00457 {
00458         ((<a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a0">SBWThread</a> *)lpParameter)-&gt;run();
00459 
00460         <font class="keywordflow">return</font> 0 ;
00461 }
00462 <font class="preprocessor">#else</font>
00463 <font class="preprocessor"></font><font class="keywordtype">void</font>* SBWThread::threadProc(<font class="keywordtype">void</font>* lpParameter)
00464 {
00465         ((<a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a0">SBWThread</a> *)lpParameter)-&gt;run();
00466         <font class="keywordflow">return</font> NULL;
00467 }
00468 <font class="preprocessor">#endif</font>
00469 <font class="preprocessor"></font>
<a name="l00474"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a2">00474</a> <font class="keywordtype">void</font> SBWThread::start()
00475 {
00476 <font class="preprocessor">#if defined(WIN32)</font>
00477 <font class="preprocessor"></font>
00478         thread = CreateThread(
00479           NULL,  <font class="comment">// pointer to security attributes</font>
00480           0,                         <font class="comment">// initial thread stack size</font>
00481           threadProc,     <font class="comment">// pointer to thread function</font>
00482           <font class="keyword">this</font>,                        <font class="comment">// argument for new thread</font>
00483           0,                     <font class="comment">// creation flags</font>
00484           &amp;threadId                         <font class="comment">// pointer to receive thread ID</font>
00485         );
00486 
00487         <font class="keywordflow">if</font> (thread == NULL)
00488                 SBWOS::ThrowError();
00489 
00490 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00491 <font class="preprocessor"></font>
00492         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Creating new thread"</font>);
00493 
00494         <font class="keywordtype">int</font> status = pthread_create(&amp;threadId, NULL, threadProc, (<font class="keywordtype">void</font> *)<font class="keyword">this</font>);
00495 
00496         <font class="keywordflow">if</font> (status != 0)
00497                 SBWOS::ThrowError(status);
00498         
00499         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"New thread's id = "</font> &lt;&lt; threadId);
00500 
00501 <font class="preprocessor">#endif</font>
00502 <font class="preprocessor"></font>}
00503 
<a name="l00510"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a4">00510</a> <font class="keywordtype">void</font> SBWThread::join()
00511 {
00512 <font class="preprocessor">#if defined(WIN32)</font>
00513 <font class="preprocessor"></font>        
00514         <font class="keywordflow">if</font> (thread == NULL || <a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a5">isThisThread</a>())
00515                 <font class="keywordflow">return</font>;
00516 
00517         <font class="keywordflow">if</font> (WaitForSingleObject(thread, INFINITE) == WAIT_FAILED)
00518                 SBWOS::ThrowError();
00519 
00520 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00521 <font class="preprocessor"></font>        
00522         <font class="keywordflow">if</font> (threadId == 0 || <a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a5">isThisThread</a>())
00523                 <font class="keywordflow">return</font>;
00524 
00525         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Waiting to join thread id = "</font> &lt;&lt; threadId);
00526 
00527         <font class="keywordtype">int</font> status = pthread_join(threadId, NULL);
00528 
00529         <font class="keywordflow">if</font> (status != 0)
00530                 SBWOS::ThrowError(status);
00531 
00532 <font class="preprocessor">#endif</font>
00533 <font class="preprocessor"></font>        joined = <font class="keyword">true</font> ;
00534 }
00535 
<a name="l00540"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a5">00540</a> <font class="keywordtype">bool</font> SBWThread::isThisThread()
00541 {
00542 <font class="preprocessor">#if defined(WIN32)</font>
00543 <font class="preprocessor"></font>        <font class="keywordflow">return</font> threadId == GetCurrentThreadId();
00544 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00545 <font class="preprocessor"></font>        <font class="keywordflow">return</font> threadId == pthread_self();
00546 <font class="preprocessor">#endif</font>
00547 <font class="preprocessor"></font>}
00548 
<a name="l00553"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#d0">00553</a> <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> SBWThread::myThreadId()
00554 {
00555 <font class="preprocessor">#ifdef WIN32</font>
00556 <font class="preprocessor"></font>        <font class="keywordflow">return</font> GetCurrentThreadId();
00557 <font class="preprocessor">#else</font>
00558 <font class="preprocessor"></font>        <font class="keywordflow">return</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>) pthread_self();
00559 <font class="preprocessor">#endif</font>
00560 <font class="preprocessor"></font>}
00561 
<a name="l00566"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#d1">00566</a> <font class="keywordtype">void</font> SBWThread::sleep(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> milliSec)
00567 {
00568 <font class="preprocessor">#if defined(WIN32)</font>
00569 <font class="preprocessor"></font>        Sleep(milliSec);
00570 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00571 <font class="preprocessor"></font>        <font class="comment">// There doesn't seem to be a thread-specific sleep in pthreads, so</font>
00572         <font class="comment">// I'm hijacking the conditional wait to achive this.  The code below</font>
00573         <font class="comment">// waits &amp; times out on a conditional variable that is never signaled.</font>
00574 
00575         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Sleeping for "</font> &lt;&lt; milliSec &lt;&lt; <font class="stringliteral">" milliseconds"</font>);
00576 
00577         <font class="keyword">struct </font>timeval now;
00578         <font class="keyword">struct </font>timespec timeout;
00579         <font class="keywordtype">int</font> status = 0;
00580 
00581         pthread_mutex_t timeMutex = PTHREAD_MUTEX_INITIALIZER;
00582         pthread_cond_t timeCond = PTHREAD_COND_INITIALIZER;
00583 
00584         status = pthread_mutex_lock(&amp;timeMutex);
00585         <font class="keywordflow">if</font> (status != 0)
00586                 SBWOS::ThrowError(status);
00587 
00588         <font class="comment">// The timeout param is an absolute time, so we have to calculate it.</font>
00589 
00590         gettimeofday(&amp;now, NULL);
00591         timeout.tv_sec = now.tv_sec;
00592         timeout.tv_nsec = 1000 * (now.tv_usec + 1000 * milliSec);
00593 
00594         status = pthread_cond_timedwait(&amp;timeCond, &amp;timeMutex, &amp;timeout);
00595         <font class="keywordflow">if</font> (status != ETIMEDOUT)
00596                 SBWOS::ThrowError(status);
00597 
00598         status = pthread_mutex_unlock(&amp;timeMutex);
00599         <font class="keywordflow">if</font> (status != 0)
00600                 SBWOS::ThrowError(status);
00601 <font class="preprocessor">#endif</font>
00602 <font class="preprocessor"></font>}
00603 
00604 <font class="comment">// -----------------------------------------------------------------------------</font>
00605 <font class="comment">// Class SBWOSEvent</font>
00606 <font class="comment">// -----------------------------------------------------------------------------</font>
00607 
00608 <font class="comment">// The following used for notifying threads of events, much like the wait()</font>
00609 <font class="comment">// and notify() provided in Java's thread functionality.</font>
00610 
<a name="l00615"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSEvent.html#a0">00615</a> <a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> SBWOSEvent::SBWOSEvent(std::string n)
00616 : name(n)
00617 {
00618 <font class="preprocessor">#if defined(WIN32)</font>
00619 <font class="preprocessor"></font>
00620         event = CreateEvent(
00621                 NULL, <font class="comment">// pointer to security attributes</font>
00622                 FALSE,  <font class="comment">// flag for manual-reset event</font>
00623                 FALSE, <font class="comment">// flag for initial state - in this case non signaled</font>
00624                 NULL) ;     <font class="comment">// pointer to event-object name</font>
00625 
00626         <font class="keywordflow">if</font> (event == NULL)
00627                 SBWOS::ThrowError();
00628 
00629 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00630 <font class="preprocessor"></font>
00631         <font class="keywordflow">if</font> (pthread_mutex_init(&amp;mutex, NULL) != 0)
00632                 SBWOS::ThrowError();
00633 
00634         <font class="keywordflow">if</font> (pthread_cond_init(&amp;event, NULL) != 0)
00635                 SBWOS::ThrowError();
00636 
00637         wakeup = <font class="keyword">false</font>;
00638 
00639         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Created new event object"</font>);
00640 
00641 <font class="preprocessor">#endif</font>
00642 <font class="preprocessor"></font>}
00643 
<a name="l00647"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSEvent.html#a1">00647</a> SBWOSEvent::~SBWOSEvent()
00648 {
00649 <font class="preprocessor">#if defined(WIN32)</font>
00650 <font class="preprocessor"></font>
00651         <font class="keywordflow">if</font> (event != NULL &amp;&amp; !CloseHandle(event))
00652                 SBWOS::ThrowError();
00653 
00654 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00655 <font class="preprocessor"></font>
00656         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Destroying event object"</font>);
00657 
00658         <font class="keywordflow">if</font> (pthread_mutex_destroy(&amp;mutex) != 0)
00659                 SBWOS::ThrowError();
00660 
00661         <font class="keywordflow">if</font> (pthread_cond_destroy(&amp;event) != 0)
00662                 SBWOS::ThrowError();
00663 
00664 <font class="preprocessor">#endif</font>
00665 <font class="preprocessor"></font>}
00666 
<a name="l00670"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSEvent.html#a2">00670</a> <font class="keywordtype">void</font> SBWOSEvent::wait()
00671 {
00672 <font class="preprocessor">#if defined(WIN32)</font>
00673 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (WaitForSingleObject(event, INFINITE) == WAIT_FAILED)
00674                 SBWOS::ThrowError();
00675 
00676 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00677 <font class="preprocessor"></font>
00678         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Waiting on event"</font>);
00679 
00680         <font class="keywordflow">if</font> (pthread_mutex_lock(&amp;mutex) != 0)
00681                 SBWOS::ThrowError();
00682 
00683         <font class="keywordflow">while</font> (!wakeup)
00684                 pthread_cond_wait(&amp;event, &amp;mutex);
00685 
00686         wakeup = <font class="keyword">false</font>;
00687 
00688         <font class="keywordflow">if</font> (pthread_mutex_unlock(&amp;mutex) != 0)
00689                 SBWOS::ThrowError();
00690 
00691 <font class="preprocessor">#endif</font>
00692 <font class="preprocessor"></font>}
00693 
<a name="l00698"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSEvent.html#a3">00698</a> <font class="keywordtype">void</font> SBWOSEvent::notify()
00699 {
00700 <font class="preprocessor">#if defined(WIN32)</font>
00701 <font class="preprocessor"></font>
00702         <font class="keywordflow">if</font> (!SetEvent(event))
00703                 SBWOS::ThrowError();
00704 
00705 <font class="preprocessor">#elif defined(HAVE_LIBPTHREAD)</font>
00706 <font class="preprocessor"></font>
00707         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Notifying other threads about event"</font>);
00708 
00709         <font class="keywordflow">if</font> (pthread_mutex_lock(&amp;mutex) != 0)
00710                 SBWOS::ThrowError();
00711 
00712         wakeup = <font class="keyword">true</font>;
00713 
00714         <font class="keywordflow">if</font> (pthread_cond_broadcast(&amp;event) != 0)
00715                 SBWOS::ThrowError();
00716 
00717         <font class="keywordflow">if</font> (pthread_mutex_unlock(&amp;mutex) != 0)
00718                 SBWOS::ThrowError();
00719 <font class="preprocessor">#endif</font>
00720 <font class="preprocessor"></font>}
00721 
<a name="l00726"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSEvent.html#a4">00726</a> <a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> std::string SBWOSEvent::getName()
00727 {
00728         <font class="keywordflow">return</font> name;
00729 }
00730 
00731 <font class="comment">// -----------------------------------------------------------------------------</font>
00732 <font class="comment">// Misc. utils</font>
00733 <font class="comment">// -----------------------------------------------------------------------------</font>
00734 
00738 <font class="preprocessor">#ifdef WIN32</font>
00739 <font class="preprocessor"></font><a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> <font class="keywordtype">void</font> SystemsBiologyWorkbench::SBWAssertMessage()
00740 {
00741         MessageBox(NULL, <font class="stringliteral">"ASSERT"</font>, <font class="stringliteral">"Assert"</font>, MB_OK);
00742 }
00743 <font class="preprocessor">#endif</font>
00744 <font class="preprocessor"></font>
00745 <font class="comment">// SBWDebug ---------------------------------------------------------------------</font>
00746 
00748 <font class="keywordtype">bool</font> SBWDebug::traceOn = <font class="keyword">false</font>;
00749 
00751 SBWOSMutex SBWDebug::traceMutex(<font class="stringliteral">"trace"</font>);
00752 
00753 <font class="comment">// inline in release configuration</font>
00754 <font class="preprocessor">#ifdef _DEBUG</font>
00755 <font class="preprocessor"></font>
00764 <a class="code" href="sbwdefs_8h.html#a0">SBW_API</a> <font class="keywordtype">void</font> SBWDebug::trace(<font class="keyword">const</font> <font class="keywordtype">char</font> *x, <font class="keyword">const</font> <font class="keywordtype">char</font> *file, <font class="keywordtype">int</font> line)
00765 {
00766         <font class="keywordflow">if</font> (traceOn)
00767         {
00768 <font class="preprocessor">#ifdef WIN32</font>
00769 <font class="preprocessor"></font>                SBWOSMutexLock ml(traceMutex);
00770 <font class="preprocessor">#endif</font>
00771 <font class="preprocessor"></font>
00772                 std::cerr &lt;&lt; <font class="stringliteral">"(trace) thread #"</font> &lt;&lt; SBWThread::myThreadId() 
00773                     &lt;&lt; <font class="stringliteral">" ("</font> &lt;&lt; file &lt;&lt; <font class="stringliteral">":"</font> &lt;&lt; line &lt;&lt; <font class="stringliteral">") "</font> 
00774                                         &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; x &lt;&lt; <font class="stringliteral">"\n"</font>; std::cerr.flush();
00775         }
00776 }
00777 <font class="preprocessor">#endif</font>
00778 <font class="preprocessor"></font>
<a name="l00785"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWDebug.html#d1">00785</a> <font class="keywordtype">void</font> SBWDebug::setTraceMode(<font class="keywordtype">bool</font> mode)
00786 {
00787         traceOn = mode;
00788 }
</pre></div><hr>
<br>
<address>
<center>
<b>Systems Biology Workbench Development Group</b><br>
ERATO Kitano Systems Biology Project<br>
Control and Dynamical Systems, MC 107-81<br>
California Institute of Technology, Pasadena, CA 91125, USA<br>
<A HREF="mailto:sysbio-team@caltech.edu">sysbio-team@caltech.edu</A><br>
<A HREF="http://www.cds.caltech.edu/erato">http://www.cds.caltech.edu/erato</A><br><br>
<small>
Generated on Fri Nov 22 00:10:05 2002 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.2.14
</small>
</center>
</address>
</body>
</html>
