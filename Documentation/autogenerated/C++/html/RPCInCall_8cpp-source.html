<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCInCall.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>RPCInCall.cpp</h1><a href="RPCInCall_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00013 <font class="comment">/*</font>
00014 <font class="comment">** Copyright 2001 California Institute of Technology and</font>
00015 <font class="comment">** Japan Science and Technology Corporation.</font>
00016 <font class="comment">** </font>
00017 <font class="comment">** This library is free software; you can redistribute it and/or modify it</font>
00018 <font class="comment">** under the terms of the GNU Lesser General Public License as published</font>
00019 <font class="comment">** by the Free Software Foundation; either version 2.1 of the License, or</font>
00020 <font class="comment">** any later version.</font>
00021 <font class="comment">** </font>
00022 <font class="comment">** This library is distributed in the hope that it will be useful, but</font>
00023 <font class="comment">** WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF</font>
00024 <font class="comment">** MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  The software and</font>
00025 <font class="comment">** documentation provided hereunder is on an "as is" basis, and the</font>
00026 <font class="comment">** California Institute of Technology and Japan Science and Technology</font>
00027 <font class="comment">** Corporation have no obligations to provide maintenance, support,</font>
00028 <font class="comment">** updates, enhancements or modifications.  In no event shall the</font>
00029 <font class="comment">** California Institute of Technology or the Japan Science and Technology</font>
00030 <font class="comment">** Corporation be liable to any party for direct, indirect, special,</font>
00031 <font class="comment">** incidental or consequential damages, including lost profits, arising</font>
00032 <font class="comment">** out of the use of this software and its documentation, even if the</font>
00033 <font class="comment">** California Institute of Technology and/or Japan Science and Technology</font>
00034 <font class="comment">** Corporation have been advised of the possibility of such damage.  See</font>
00035 <font class="comment">** the GNU Lesser General Public License for more details.</font>
00036 <font class="comment">** </font>
00037 <font class="comment">** You should have received a copy of the GNU Lesser General Public License</font>
00038 <font class="comment">** along with this library; if not, write to the Free Software Foundation,</font>
00039 <font class="comment">** Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</font>
00040 <font class="comment">**</font>
00041 <font class="comment">** The original code contained here was initially developed by:</font>
00042 <font class="comment">**</font>
00043 <font class="comment">**     Andrew Finney, Herbert Sauro, Michael Hucka, Hamid Bolouri</font>
00044 <font class="comment">**     The Systems Biology Workbench Development Group</font>
00045 <font class="comment">**     ERATO Kitano Systems Biology Project</font>
00046 <font class="comment">**     Control and Dynamical Systems, MC 107-81</font>
00047 <font class="comment">**     California Institute of Technology</font>
00048 <font class="comment">**     Pasadena, CA, 91125, USA</font>
00049 <font class="comment">**</font>
00050 <font class="comment">**     http://www.cds.caltech.edu/erato</font>
00051 <font class="comment">**     mailto:sysbio-team@caltech.edu</font>
00052 <font class="comment">**</font>
00053 <font class="comment">** Contributor(s):</font>
00054 <font class="comment">**</font>
00055 <font class="comment">*/</font>
00056 
00057 <font class="comment">// RPCInCall.cpp: implementation of the RPCInCall class.</font>
00058 <font class="comment">//</font>
00060 <font class="comment"></font>
00061 <font class="preprocessor">#include "<a class="code" href="stdafx_8h.html">stdafx.h</a>"</font>
00062 <font class="preprocessor">#include "<a class="code" href="RPCInCall_8h.html">RPCInCall.h</a>"</font>
00063 <font class="preprocessor">#include "<a class="code" href="DataBlockWriterClass_8h.html">DataBlockWriterClass.h</a>"</font>
00064 <font class="preprocessor">#include "<a class="code" href="SBWRPC_8h.html">SBWRPC.h</a>"</font>
00065 <font class="preprocessor">#include "<a class="code" href="Receiver_8h.html">Receiver.h</a>"</font>
00066 
00067 <font class="keyword">namespace </font>SystemsBiologyWorkbench
00068 {
00069 
<a name="l00071"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCallThread.html">00071</a> <font class="keyword">class </font>RPCInCallThread : <font class="keyword">public</font> SBWThread
00072 {
00073 <font class="keyword">public</font>:
<a name="l00078"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCallThread.html#a0">00078</a>         <a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCallThread.html#a0">RPCInCallThread</a>(RPCInCall *x) : <a class="code" href="classSystemsBiologyWorkbench_1_1SBWThread.html#a0">SBWThread</a>("in call"), inCall(x) {}
00079 
<a name="l00081"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCallThread.html#a1">00081</a>         <font class="keywordtype">void</font> <a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCallThread.html#a1">run</a>() { inCall-&gt;run(); }
00082 
00083 <font class="keyword">private</font>:
00085         RPCInCall *inCall;
00086 };
00087 
00088 }
00089 
00090 <font class="keyword">using</font> <font class="keyword">namespace </font>SystemsBiologyWorkbench ;
00091 
<a name="l00096"></a><a class="code" href="RPCInCall_8cpp.html#a0">00096</a> <font class="keywordtype">void</font> <a class="code" href="RPCInCall_8cpp.html#a0">defaultIncomingCallThreadCreator</a>(RPCInCall *x)
00097 {
00098         x-&gt;start();
00099 }
00100 
00102 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a5">IncomingCallThreadCreator</a> RPCInCall::threadCreator = <a class="code" href="RPCInCall_8cpp.html#a0">defaultIncomingCallThreadCreator</a> ;
00103 
<a name="l00110"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a0">00110</a> RPCInCall::RPCInCall(SBWRPC *s, Receiver *r, std::string name)
00111     : thread(NULL), event(name), completeEvent("complete event"),
00112       rpc(s), receiver(r), active(false), operational(true), callPending(false),
00113       completed(false)
00114 {
00115 }
00116 
<a name="l00120"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a1">00120</a> RPCInCall::~RPCInCall()
00121 {
00122         <font class="keywordflow">if</font> (thread)
00123                 <font class="keyword">delete</font> thread ;
00124 }
00125 
<a name="l00127"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a6">00127</a> <font class="keywordtype">void</font> RPCInCall::start()
00128 {
00129         thread = <font class="keyword">new</font> RPCInCallThread(<font class="keyword">this</font>);
00130         thread-&gt;start();
00131 }
00132 
<a name="l00134"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a8">00134</a> <font class="keywordtype">void</font> RPCInCall::waitTillComplete()
00135 {
00136         <font class="keywordflow">if</font> (thread)
00137                 thread-&gt;join();
00138         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (!completed)
00139                 completeEvent.wait();
00140 }
00141 
<a name="l00148"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a5">00148</a> <font class="keywordtype">void</font> RPCInCall::run()
00149 {
00150         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Running new message-handling thread"</font>);
00151 
00152         <font class="keywordflow">while</font> (operational)
00153         {
00154                 <font class="keywordflow">try</font>
00155                 {
00156                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Waiting for a new message"</font>);
00157 
00158                         event.wait();
00159 
00160                         <font class="keywordflow">if</font> (!operational)
00161                         {
00162                                 completed = <font class="keyword">true</font> ;
00163                                 completeEvent.notify();
00164                                 <font class="keywordflow">return</font> ;
00165                         }
00166 
00167                         callPending = <font class="keyword">false</font> ;
00168 
00169                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Parsing new message"</font>);
00170 
00171                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> messageId, fromModuleId;
00172 
00173                         reader.getWithoutType(messageId);
00174                         reader.getWithoutType(fromModuleId);
00175 
00176                         DataBlockWriter result;
00177 
00178                         <font class="keywordflow">try</font>
00179                         {
00180                                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> serviceId, methodId;
00181 
00182                                 reader.getWithoutType(serviceId);
00183                                 reader.getWithoutType(methodId);
00184 
00185                                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Received msg id = "</font> &lt;&lt; messageId
00186                                           &lt;&lt; <font class="stringliteral">", src module = "</font> &lt;&lt; fromModuleId
00187                                           &lt;&lt; <font class="stringliteral">", service = "</font> &lt;&lt; serviceId
00188                                           &lt;&lt; <font class="stringliteral">", method = "</font> &lt;&lt; methodId);
00189 
00190                                 <font class="keywordflow">if</font> (serviceId == <a class="code" href="namespaceSystemsBiologyWorkbench.html#a63a47">SBWSystemService</a>)
00191                                 {
00192                                         <font class="keywordflow">switch</font> (methodId)
00193                                         {
00194                                                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a65a53">SBWOnOtherModuleInstanceShutdownMethod</a> :
00195                                                         {
00196                                                                 <font class="keywordtype">int</font> moduleId ;
00197 
00198                                                                 reader.get(moduleId);
00199                                                                 rpc-&gt;onOtherModuleInstanceShutdown(moduleId);
00200                                                         }
00201                                                         <font class="keywordflow">break</font> ;
00202                                                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a65a56">SBWOnOtherModuleInstanceStartupMethod</a> :
00203                                                         {
00204                                                                 <font class="keywordtype">int</font> moduleId ;
00205 
00206                                                                 reader.get(moduleId);
00207                                                                 rpc-&gt;onOtherModuleInstanceStartup(moduleId);
00208                                                         }
00209                                                         <font class="keywordflow">break</font> ;
00210                                                 <font class="keywordflow">case</font> <a class="code" href="namespaceSystemsBiologyWorkbench.html#a65a57">SBWOnRegistrationChangeMethod</a> :
00211                                                         rpc-&gt;onRegistrationChange();
00212                                                         <font class="keywordflow">break</font>;
00213 
00214                                                 <font class="keywordflow">default</font>:
00215                                                         result = receiver-&gt;receive(fromModuleId, serviceId, methodId, reader);
00216                                         }
00217                                 }
00218                                 <font class="keywordflow">else</font>
00219                                         result = receiver-&gt;receive(fromModuleId, serviceId, methodId, reader);
00220 
00221                                 <font class="keywordflow">if</font> (transmitReply)
00222                                 {
00223                                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Transmitting reply to module "</font> &lt;&lt; fromModuleId);
00224 
00225                                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length ;
00226                                         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message = result.createReply(fromModuleId, messageId, length);
00227                                         rpc-&gt;transmit(fromModuleId, message, length);
00228                                 }
00229                         }
00230                         <font class="keywordflow">catch</font> (SBWException *e)
00231                         {
00232                                 <font class="keywordflow">if</font> (transmitReply)
00233                                 {
00234                                         e-&gt;log();
00235 
00236                                         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length ;
00237                                         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *message = DataBlockWriter::createException(
00238                                                 fromModuleId, 
00239                                                 messageId,
00240                                                 e-&gt;getCode(),
00241                                                 e-&gt;getMessage().c_str(),
00242                                                 e-&gt;getDetailedMessage().c_str(),
00243                                                 length);
00244                                         
00245                                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Transmitting the following exception"</font>
00246                                                   &lt;&lt; message);
00247 
00248                                         <font class="keyword">delete</font> e ;
00249                                         rpc-&gt;transmit(fromModuleId, message, length);
00250                                 }
00251                                 <font class="keywordflow">else</font>
00252                                         <font class="keywordflow">throw</font> ;
00253                         }
00254                 }
00255                 <font class="keywordflow">catch</font> (SBWException *e)
00256                 {
00257                         e-&gt;log();
00258                         <font class="keyword">delete</font> e ;
00259                 }
00260 
00261                 active = <font class="keyword">false</font> ;
00262         }
00263 
00264         completed = <font class="keyword">true</font> ;
00265         completeEvent.notify();
00266 }
00267 
<a name="l00272"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a3">00272</a> <font class="keywordtype">bool</font> RPCInCall::isActive()
00273 {
00274         <font class="keywordflow">return</font> active; 
00275 }
00276 
<a name="l00283"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a2">00283</a> <font class="keywordtype">void</font> RPCInCall::execute(DataBlockReader r, <font class="keywordtype">bool</font> tr)
00284 {
00285         <font class="keywordflow">if</font> (<a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a3">isActive</a>())
00286         {
00287                 SBWException::log(<font class="stringliteral">"ERROR ATTEMPTING TO EXECUTE INCOMING CALL IN ACTIVE CALL THREAD"</font>);
00288                 <font class="keywordflow">return</font>;
00289         }
00290 
00291         active = <font class="keyword">true</font> ;
00292         reader = r;
00293         transmitReply = tr ;
00294 
00295         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Execute call, transmitReply = "</font> &lt;&lt; tr);
00296 
00297         callPending = <font class="keyword">true</font> ;
00298         event.notify();
00299 }
00300 
<a name="l00302"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a4">00302</a> <font class="keywordtype">void</font> RPCInCall::stop()
00303 {
00304         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Stopping"</font>);
00305 
00306         operational = <font class="keyword">false</font> ;
00307         event.notify();
00308 }
00309 
<a name="l00311"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#a7">00311</a> <font class="keywordtype">void</font> RPCInCall::createThread()
00312 {
00313         threadCreator(<font class="keyword">this</font>);
00314 }
00315 
00316 <font class="comment">// static</font>
<a name="l00321"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#d0">00321</a> <font class="comment"></font><font class="keywordtype">void</font> RPCInCall::registerThreadCreator(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a5">IncomingCallThreadCreator</a> f)
00322 {
00323         threadCreator = f ;
00324 }
00325 
00326 <font class="comment">// static</font>
<a name="l00331"></a><a class="code" href="classSystemsBiologyWorkbench_1_1RPCInCall.html#d1">00331</a> <font class="comment"></font><font class="keywordtype">void</font> RPCInCall::processIncomingCalls(RPCInCall *inCall)
00332 {
00333         inCall-&gt;run();
00334 }
</pre></div><hr>
<br>
<address>
<center>
<b>Systems Biology Workbench Development Group</b><br>
ERATO Kitano Systems Biology Project<br>
Control and Dynamical Systems, MC 107-81<br>
California Institute of Technology, Pasadena, CA 91125, USA<br>
<A HREF="mailto:sysbio-team@caltech.edu">sysbio-team@caltech.edu</A><br>
<A HREF="http://www.cds.caltech.edu/erato">http://www.cds.caltech.edu/erato</A><br><br>
<small>
Generated on Fri Nov 22 00:10:05 2002 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.2.14
</small>
</center>
</address>
</body>
</html>
