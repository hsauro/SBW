<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SBWOSSocket.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>SBWOSSocket.cpp</h1><a href="SBWOSSocket_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00013 <font class="comment">/*</font>
00014 <font class="comment">** Copyright 2001 California Institute of Technology and</font>
00015 <font class="comment">** Japan Science and Technology Corporation.</font>
00016 <font class="comment">** </font>
00017 <font class="comment">** This library is free software; you can redistribute it and/or modify it</font>
00018 <font class="comment">** under the terms of the GNU Lesser General Public License as published</font>
00019 <font class="comment">** by the Free Software Foundation; either version 2.1 of the License, or</font>
00020 <font class="comment">** any later version.</font>
00021 <font class="comment">** </font>
00022 <font class="comment">** This library is distributed in the hope that it will be useful, but</font>
00023 <font class="comment">** WITHOUT ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF</font>
00024 <font class="comment">** MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  The software and</font>
00025 <font class="comment">** documentation provided hereunder is on an "as is" basis, and the</font>
00026 <font class="comment">** California Institute of Technology and Japan Science and Technology</font>
00027 <font class="comment">** Corporation have no obligations to provide maintenance, support,</font>
00028 <font class="comment">** updates, enhancements or modifications.  In no event shall the</font>
00029 <font class="comment">** California Institute of Technology or the Japan Science and Technology</font>
00030 <font class="comment">** Corporation be liable to any party for direct, indirect, special,</font>
00031 <font class="comment">** incidental or consequential damages, including lost profits, arising</font>
00032 <font class="comment">** out of the use of this software and its documentation, even if the</font>
00033 <font class="comment">** California Institute of Technology and/or Japan Science and Technology</font>
00034 <font class="comment">** Corporation have been advised of the possibility of such damage.  See</font>
00035 <font class="comment">** the GNU Lesser General Public License for more details.</font>
00036 <font class="comment">** </font>
00037 <font class="comment">** You should have received a copy of the GNU Lesser General Public License</font>
00038 <font class="comment">** along with this library; if not, write to the Free Software Foundation,</font>
00039 <font class="comment">** Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</font>
00040 <font class="comment">**</font>
00041 <font class="comment">** The original code contained here was initially developed by:</font>
00042 <font class="comment">**</font>
00043 <font class="comment">**     Andrew Finney, Herbert Sauro, Michael Hucka, Hamid Bolouri</font>
00044 <font class="comment">**     The Systems Biology Workbench Development Group</font>
00045 <font class="comment">**     ERATO Kitano Systems Biology Project</font>
00046 <font class="comment">**     Control and Dynamical Systems, MC 107-81</font>
00047 <font class="comment">**     California Institute of Technology</font>
00048 <font class="comment">**     Pasadena, CA, 91125, USA</font>
00049 <font class="comment">**</font>
00050 <font class="comment">**     http://www.cds.caltech.edu/erato</font>
00051 <font class="comment">**     mailto:sysbio-team@caltech.edu</font>
00052 <font class="comment">**</font>
00053 <font class="comment">** Contributor(s):</font>
00054 <font class="comment">**</font>
00055 <font class="comment">*/</font>
00056 
00057 <font class="comment">// SBWOSSocket.cpp: implementation of the SBWOSSocket class.</font>
00058 <font class="comment">//</font>
00060 <font class="comment"></font>
00061 <font class="preprocessor">#include "<a class="code" href="stdafx_8h.html">stdafx.h</a>"</font>
00062 <font class="preprocessor">#include "<a class="code" href="SBWRawException_8h.html">SBWRawException.h</a>"</font>
00063 <font class="preprocessor">#include &lt;string.h&gt;</font>
00064 
00065 <font class="preprocessor">#if defined(WIN32)</font>
00066 <font class="preprocessor"></font><font class="preprocessor">#include &lt;winsock2.h&gt;</font>
00067 <font class="preprocessor">#else</font>
00068 <font class="preprocessor"></font><font class="preprocessor">#ifdef HAVE_ERRNO_H</font>
00069 <font class="preprocessor"></font><font class="preprocessor">#include &lt;errno.h&gt;</font>
00070 <font class="preprocessor">#endif</font>
00071 <font class="preprocessor"></font>
00072 <font class="preprocessor">#ifdef HAVE_UNISTD_H</font>
00073 <font class="preprocessor"></font><font class="preprocessor">#include &lt;unistd.h&gt;</font>
00074 <font class="preprocessor">#endif</font>
00075 <font class="preprocessor"></font>
00076 <font class="preprocessor">#ifdef HAVE_SYS_TYPES_H</font>
00077 <font class="preprocessor"></font><font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00078 <font class="preprocessor">#endif</font>
00079 <font class="preprocessor"></font>
00080 <font class="preprocessor">#ifdef HAVE_SYS_SOCKET_H</font>
00081 <font class="preprocessor"></font><font class="preprocessor">#include &lt;sys/socket.h&gt;</font>
00082 <font class="preprocessor">#endif</font>
00083 <font class="preprocessor"></font>
00084 <font class="preprocessor">#ifdef HAVE_NETINET_IN_H</font>
00085 <font class="preprocessor"></font><font class="preprocessor">#include &lt;netinet/in.h&gt;</font>
00086 <font class="preprocessor">#endif</font>
00087 <font class="preprocessor"></font>
00088 <font class="preprocessor">#ifdef HAVE_NETINET_TCP_H</font>
00089 <font class="preprocessor"></font><font class="preprocessor">#include &lt;netinet/tcp.h&gt;</font>
00090 <font class="preprocessor">#endif</font>
00091 <font class="preprocessor"></font>
00092 <font class="preprocessor">#ifdef HAVE_ARPA_INET_H</font>
00093 <font class="preprocessor"></font><font class="preprocessor">#include &lt;arpa/inet.h&gt;</font>
00094 <font class="preprocessor">#endif</font>
00095 <font class="preprocessor"></font>
00096 <font class="preprocessor">#ifdef HAVE_NETDB_H</font>
00097 <font class="preprocessor"></font><font class="preprocessor">#include &lt;netdb.h&gt;</font>
00098 <font class="preprocessor">#endif</font>
00099 <font class="preprocessor"></font>
00100 <font class="preprocessor">#endif</font>
00101 <font class="preprocessor"></font>
00102 <font class="preprocessor">#include "<a class="code" href="SBWOSSocket_8h.html">SBWOSSocket.h</a>"</font>
00103 
00104 <font class="keyword">using</font> <font class="keyword">namespace </font>SystemsBiologyWorkbench ;
00105 
00107 <font class="comment">// Construction/Destruction</font>
00109 <font class="comment"></font>
00110 <font class="preprocessor">#ifdef WIN32</font>
00111 <font class="preprocessor"></font>
00114 SBWOSSocketSystem::SBWOSSocketSystem()
00115 {
00116         WORD wVersionRequested;
00117         WSADATA wsaData;
00118         <font class="keywordtype">int</font> err;
00119 
00120         wVersionRequested = MAKEWORD( 3, 0 );
00121 
00122         err = WSAStartup( wVersionRequested, &amp;wsaData );
00123         assert ( err == 0 );
00124 }
00125 
00129 SBWOSSocketSystem::~SBWOSSocketSystem()
00130 {
00131         WSACleanup();
00132 }
00133 
00135 SBWOSSocketSystem SBWOSSocket::system;
00136 <font class="preprocessor">#endif // WIN32</font>
00137 <font class="preprocessor"></font>
<a name="l00143"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSSocket.html#a0">00143</a> SBWOSSocket::SBWOSSocket(<a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> port, <font class="keyword">const</font> <font class="keywordtype">char</font> *hostname)
00144 {
00145         <font class="keywordflow">if</font> (hostname == NULL)
00146         {
00147                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Opening socket to localhost"</font>);
00148         }
00149         <font class="keywordflow">else</font>
00150         {
00151                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Opening socket to host named '"</font> &lt;&lt; hostname &lt;&lt; <font class="stringliteral">"'"</font>);
00152         }
00153 
00154         sock = socket(AF_INET, SOCK_STREAM, 0);
00155 
00156         <font class="keywordflow">if</font> (sock == <a class="code" href="SBWOSSocket_8h.html#a4">INVALID_SOCKET</a>)
00157         {
00158             <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Could not create socket"</font>);
00159                 throwError();
00160         }
00161 
00162         sockaddr_in address ;
00163 
00164         address.sin_family = AF_INET;<font class="comment">// short</font>
00165         address.sin_port = htons(port) ; <font class="comment">// u_short</font>
00166 
00167 <font class="preprocessor">#if defined(WIN32)</font>
00168 <font class="preprocessor"></font>        <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> hostAddress ;
00169 <font class="preprocessor">#else</font>
00170 <font class="preprocessor"></font>        in_addr_t hostAddress ;
00171 <font class="preprocessor">#endif</font>
00172 <font class="preprocessor"></font>
00173         <font class="keywordflow">if</font> (hostname == NULL || strlen(hostname) == 0
00174                 || strcmp(hostname, <font class="stringliteral">"localhost"</font>) == 0)
00175         {
00176                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Host address = 127.0.0.1"</font>);
00177                 hostAddress = inet_addr(<font class="stringliteral">"127.0.0.1"</font>);
00178         }
00179         <font class="keywordflow">else</font>
00180         {
00181                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Trying to obtain address for host '"</font> &lt;&lt; hostname &lt;&lt; <font class="stringliteral">"'"</font>);
00182                 std::string given(hostname);
00183                 std::string::size_type first = given.find_first_not_of(<font class="stringliteral">"1234567890."</font>);
00184 
00185                 <font class="keywordflow">if</font> (first == std::string::npos)
00186                 {
00187                         hostAddress = inet_addr(hostname) ;
00188                 }
00189                 <font class="keywordflow">else</font>
00190                 {
00191                         <font class="keyword">struct </font>hostent *hptr = gethostbyname(hostname);
00192 
00193                         <font class="keywordflow">if</font> (hptr == NULL)
00194                         {
00195                                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Failed to get host entry from gethostbyname"</font>);
00196                                 throwError();
00197                         }
00198 
00199                         memcpy(&amp;hostAddress, hptr-&gt;h_addr_list[0], <font class="keyword">sizeof</font>(hostAddress));
00200                 }
00201         }
00202 
00203 <font class="preprocessor">#if defined(WIN32)</font>
00204 <font class="preprocessor"></font>        address.sin_addr.S_un.S_addr = hostAddress; 
00205         <font class="keywordflow">if</font> (address.sin_addr.S_un.S_addr == INADDR_NONE)
00206                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"address error"</font>);
00207 <font class="preprocessor">#else</font>
00208 <font class="preprocessor"></font>        address.sin_addr.s_addr = hostAddress; 
00209         <font class="keywordflow">if</font> (address.sin_addr.s_addr == INADDR_NONE)
00210                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"address error"</font>);
00211 <font class="preprocessor">#endif</font>
00212 <font class="preprocessor"></font>
00213         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Connecting socket"</font>);
00214         <font class="keywordflow">if</font> (connect(sock, (sockaddr *)&amp;address, <font class="keyword">sizeof</font>(address)) == <a class="code" href="SBWOSSocket_8h.html#a5">SOCKET_ERROR</a>)
00215                 throwError();
00216 }
00217 
<a name="l00221"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSSocket.html#a1">00221</a> SBWOSSocket::~SBWOSSocket()
00222 {
00223         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Destroying socket object"</font>);
00224 <font class="preprocessor">#ifdef WIN32</font>
00225 <font class="preprocessor"></font>        WSAEVENT event = WSACreateEvent();
00226 
00227         <font class="keywordflow">if</font> (event == WSA_INVALID_EVENT)
00228                 throwError();
00229 
00230         <font class="keywordflow">if</font> (WSAEventSelect(sock, event, FD_CLOSE) == <a class="code" href="SBWOSSocket_8h.html#a5">SOCKET_ERROR</a>)
00231                 throwError();
00232 <font class="preprocessor">#endif</font>
00233 <font class="preprocessor"></font>
00234         <font class="keywordflow">if</font> (shutdown(sock, <a class="code" href="SBWOSSocket_8h.html#a6">SD_SEND</a>) == <a class="code" href="SBWOSSocket_8h.html#a5">SOCKET_ERROR</a>)
00235                 throwError();
00236 
00237 <font class="preprocessor">#ifdef WIN32</font>
00238 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (WSAWaitForMultipleEvents(1, &amp;event, TRUE, WSA_INFINITE, FALSE)
00239                         == WSA_WAIT_FAILED)
00240         {
00241                 throwError();
00242         }
00243 <font class="preprocessor">#endif</font>
00244 <font class="preprocessor"></font>
00245         <font class="keywordflow">if</font> (<a class="code" href="SBWOSSocket_8h.html#a7">closesocket</a>(sock) == <a class="code" href="SBWOSSocket_8h.html#a5">SOCKET_ERROR</a>)
00246                 throwError();
00247 }
00248 
<a name="l00255"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSSocket.html#a2">00255</a> <font class="keywordtype">void</font> SBWOSSocket::receive(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *data, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length)
00256 {
00257         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> cursor = 0 ;
00258 
00259         <font class="keywordflow">while</font> (cursor != length)
00260         {
00261                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> result = recv(sock, (<font class="keywordtype">char</font> *)data + cursor, length - cursor, 0);
00262 
00263                 <font class="keywordflow">if</font> (result == 0)
00264                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"graceful disconnect while reading"</font>);
00265 
00266                 <font class="keywordflow">if</font> (result == <a class="code" href="SBWOSSocket_8h.html#a5">SOCKET_ERROR</a>)
00267                         throwError();
00268 
00269                 cursor += result ;
00270         }
00271 }
00272 
<a name="l00279"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSSocket.html#a3">00279</a> <font class="keywordtype">void</font> SBWOSSocket::transmit(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *data, <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> length)
00280 {
00281         <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> cursor = 0;
00282 
00283         <font class="keywordflow">while</font> (cursor != length)
00284         {
00285                 <a class="code" href="namespaceSystemsBiologyWorkbench.html#a42">Integer</a> result = send(sock, (<font class="keywordtype">char</font> *)data + cursor, length - cursor, 0);
00286                 
00287                 <font class="keywordflow">if</font> (result == <a class="code" href="SBWOSSocket_8h.html#a5">SOCKET_ERROR</a>)
00288                         throwError();
00289 
00290                 cursor += result ;
00291         }
00292 }
00293 
00298 <font class="keywordtype">void</font> SBWOSSocket::throwError()
00299 {
00300 <font class="preprocessor">#if defined(WIN32)</font>
00301 <font class="preprocessor"></font>        <font class="keywordtype">int</font> code = WSAGetLastError();
00302         
00303         <font class="keywordflow">switch</font> (code)
00304         {
00305                 <font class="keywordflow">case</font> WSANOTINITIALISED :
00306                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"A successful WSAStartup must occur before using this function."</font>);
00307 
00308                 <font class="keywordflow">case</font> WSAENETDOWN :
00309                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The network subsystem or the associated service provider has failed."</font>);
00310 
00311                 <font class="keywordflow">case</font> WSAEAFNOSUPPORT :
00312                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The specified address family is not supported."</font>);
00313                         
00314                 <font class="keywordflow">case</font> WSAEINPROGRESS :
00315                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"A blocking Windows Sockets 1.1 call is in progress, or the service provider is still processing a callback function."</font>);
00316 
00317                 <font class="keywordflow">case</font> WSAEMFILE :
00318                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"No more socket descriptors are available."</font>);
00319                         
00320                 <font class="keywordflow">case</font> WSAENOBUFS :
00321                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"No buffer space is available. The socket cannot be created."</font>);
00322                         
00323                 <font class="keywordflow">case</font> WSAEPROTONOSUPPORT :
00324                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The specified protocol is not supported."</font>);
00325                         
00326                 <font class="keywordflow">case</font> WSAEPROTOTYPE :
00327                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The specified protocol is the wrong type for this socket."</font>);
00328                         
00329                 <font class="keywordflow">case</font> WSAESOCKTNOSUPPORT :
00330                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The specified socket type is not supported in this address family."</font>);
00331                         
00332                 <font class="keywordflow">case</font> WSAEADDRINUSE :
00333                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The socket's local address is already in use and the socket was not marked to allow address reuse with SO_REUSEADDR. This error usually occurs when executing bind, but could be delayed until this function if the bind was to a partially wild-card address (involving ADDR_ANY) and if a specific address needs to be committed at the time of this function."</font>); 
00334 
00335                 <font class="keywordflow">case</font> WSAEINTR :
00336                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The (blocking) Windows Socket 1.1 call was canceled through WSACancelBlockingCall."</font>); 
00337 
00338                 <font class="keywordflow">case</font> WSAEALREADY :
00339                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"A nonblocking connect call is in progress on the specified socket."</font>);
00340 
00341                 <font class="keywordflow">case</font> WSAEADDRNOTAVAIL :
00342                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The remote address is not a valid address (such as ADDR_ANY)."</font>);
00343                         
00344                 <font class="keywordflow">case</font> WSAECONNREFUSED :
00345                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(<font class="stringliteral">"The attempt to connect was forcefully rejected."</font>);
00346                         
00347                 <font class="keywordflow">case</font> WSAEFAULT :
00348                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The name or the namelen parameter is not a valid part of the user address space, the namelen parameter is too small, or the name parameter contains incorrect address format for the associated address family."</font>); 
00349 
00350                 <font class="keywordflow">case</font> WSAEINVAL :
00351                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The parameter s is a listening socket, or the destination address specified is not consistent with that of the constrained group the socket belongs to."</font>); 
00352 
00353                 <font class="keywordflow">case</font> WSAEISCONN :
00354                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The socket is already connected (connection-oriented sockets only)."</font>);
00355                         
00356                 <font class="keywordflow">case</font> WSAENETUNREACH :
00357                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The network cannot be reached from this host at this time."</font>);
00358                         
00359                 <font class="keywordflow">case</font> WSAENOTSOCK :
00360                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The descriptor is not a socket."</font>);
00361                         
00362                 <font class="keywordflow">case</font> WSAETIMEDOUT :
00363                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(<font class="stringliteral">"Attempt to connect timed out without establishing a connection."</font>);
00364                         
00365                 <font class="keywordflow">case</font> WSAEWOULDBLOCK :
00366                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The socket is marked as nonblocking and the connection cannot be completed immediately."</font>); 
00367 
00368                 <font class="keywordflow">case</font> WSAEACCES :
00369                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"Attempt to connect datagram socket to broadcast address failed because setsockopt option SO_BROADCAST is not enabled."</font>); 
00370 
00371                 <font class="keywordflow">case</font> WSAENOTCONN :
00372                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The socket is not connected."</font>);
00373                         
00374                 <font class="keywordflow">case</font> WSAENETRESET :
00375                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The connection has been broken due to the keep-alive activity detecting a failure while the operation was in progress."</font>);
00376 
00377                 <font class="keywordflow">case</font> WSAEOPNOTSUPP :
00378                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"MSG_OOB was specified, but the socket is not stream-style such as type SOCK_STREAM, out-of-band data is not supported in the communication domain associated with this socket, or the socket is unidirectional and supports only send operations."</font>);
00379                         
00380                 <font class="keywordflow">case</font> WSAESHUTDOWN :
00381                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The socket has been shut down; it is not possible to recv on a socket after shutdown has been invoked with how set to SD_RECEIVE or SD_BOTH."</font>); 
00382 
00383                 <font class="keywordflow">case</font> WSAEMSGSIZE :
00384                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"The message was too large to fit into the specified buffer and was truncated."</font>);
00385                         
00386                 <font class="keywordflow">case</font> WSAECONNABORTED :
00387                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The virtual circuit was terminated due to a time-out or other failure. The application should close the socket as it is no longer usable."</font>);
00388                         
00389                 <font class="keywordflow">case</font> WSAECONNRESET :
00390                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The virtual circuit was reset by the remote side executing a \"hard\" or \"abortive\" close. The application should close the socket as it is no longer usable. On a UDP datagram socket this error would indicate that a previous send operation resulted in an ICMP \"Port Unreachable\" message."</font>); 
00391 
00392                 <font class="keywordflow">case</font> WSAEHOSTUNREACH :
00393                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWDisconnectException(<font class="stringliteral">"The remote host cannot be reached from this host at this time."</font>); 
00394 
00395                 <font class="keywordflow">case</font> WSAHOST_NOT_FOUND :
00396                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(<font class="stringliteral">"Authoritative answer host not found"</font>);
00397 
00398                 <font class="keywordflow">case</font> WSATRY_AGAIN :
00399                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(<font class="stringliteral">"Nonauthoritative host not found, or server failure"</font>);
00400                 
00401                 <font class="keywordflow">case</font> WSANO_RECOVERY :
00402                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(<font class="stringliteral">"A nonrecoverable error occurred"</font>);
00403 
00404                 <font class="keywordflow">case</font> WSANO_DATA :
00405                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(<font class="stringliteral">"Valid name, no data record of requested type"</font>);
00406 
00407 
00408                 <font class="keywordflow">default</font>:
00409                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"Unknown code"</font>);
00410 
00411         }
00412 
00413 <font class="preprocessor">#elif defined(HAVE_ERRNO_H)</font>
00414 <font class="preprocessor"></font>
00415         <font class="keywordflow">switch</font> (errno)
00416         {
00417         <font class="keywordflow">case</font> EPROTONOSUPPORT:
00418         <font class="keywordflow">case</font> EAFNOSUPPORT:
00419         <font class="keywordflow">case</font> EPERM:
00420         <font class="keywordflow">case</font> ENFILE:
00421         <font class="keywordflow">case</font> EMFILE:
00422         <font class="keywordflow">case</font> ENOBUFS:
00423         <font class="keywordflow">case</font> ENOMEM:
00424         <font class="keywordflow">case</font> EINVAL:
00425         <font class="keywordflow">case</font> EACCES:
00426         <font class="keywordflow">case</font> EFAULT:
00427         <font class="keywordflow">case</font> ENOTCONN:
00428         <font class="keywordflow">case</font> ENOTSOCK:
00429         <font class="keywordflow">case</font> EBADF:
00430         <font class="keywordflow">case</font> EADDRINUSE:
00431                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(strerror(errno));
00432 
00433         <font class="keywordflow">case</font> ECONNREFUSED:
00434         <font class="keywordflow">case</font> EISCONN:
00435         <font class="keywordflow">case</font> ETIMEDOUT:
00436         <font class="keywordflow">case</font> EINPROGRESS:
00437         <font class="keywordflow">case</font> ENETUNREACH:
00438         <font class="keywordflow">case</font> EALREADY:
00439         <font class="keywordflow">case</font> EAGAIN:
00440                 <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWConnectException(strerror(errno));
00441 
00442                 <font class="keywordflow">default</font>:
00443                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"Unknown code"</font>);
00444 
00445         }
00446 
00447 <font class="preprocessor">#endif</font>
00448 <font class="preprocessor"></font>}
00449 
<a name="l00450"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSSocket.html#d0">00450</a> <font class="keywordtype">bool</font> SBWOSSocket::isLocalAddress(<font class="keyword">const</font> <font class="keywordtype">char</font> *hostname)
00451 {
00452         <font class="keywordflow">return</font> strlen(hostname) == 0 || strcmp(hostname, <font class="stringliteral">"localhost"</font>) == 0
00453                         || strcmp(hostname, <font class="stringliteral">"127.0.0.1"</font>) == 0;
00454 }
00455 
<a name="l00456"></a><a class="code" href="classSystemsBiologyWorkbench_1_1SBWOSSocket.html#d1">00456</a> <font class="keywordtype">bool</font> SBWOSSocket::portInUse(<font class="keywordtype">int</font> port)
00457 {
00458     <font class="keywordtype">int</font> sock = socket(AF_INET, SOCK_STREAM, 0);
00459     <font class="keywordtype">bool</font> inUse = <font class="keyword">false</font>;
00460 
00461     <font class="keywordflow">if</font> (sock &gt; 0)
00462     {
00463                 <font class="keyword">struct </font>sockaddr_in addr;
00464                 
00465                 addr.sin_family = AF_INET;
00466                 addr.sin_port = htons(port);
00467 
00468 <font class="preprocessor">#if defined(WIN32)</font>
00469 <font class="preprocessor"></font>        addr.sin_addr.S_un.S_addr = inet_addr(<font class="stringliteral">"127.0.0.1"</font>);
00470                 <font class="keywordflow">if</font> (addr.sin_addr.S_un.S_addr == INADDR_NONE)
00471                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"address error"</font>);
00472 <font class="preprocessor">#else</font>
00473 <font class="preprocessor"></font>        addr.sin_addr.s_addr = inet_addr(<font class="stringliteral">"127.0.0.1"</font>);
00474                 <font class="keywordflow">if</font> (addr.sin_addr.s_addr == INADDR_NONE)
00475                         <font class="keywordflow">throw</font> <font class="keyword">new</font> SBWSocketException(<font class="stringliteral">"address error"</font>);
00476 <font class="preprocessor">#endif</font>
00477 <font class="preprocessor"></font>
00478                 <font class="comment">// A failure to bind to the socket indicates it's in use (or unusable),</font>
00479                 <font class="comment">// but a successful bind is not enough to say that it's NOT in use.</font>
00480 
00481                 <font class="keywordtype">int</font> bindCode = bind(sock, (<font class="keyword">struct</font> sockaddr *) &amp;addr, <font class="keyword">sizeof</font>(addr));
00482 
00483 <font class="preprocessor">#if defined(WIN32)</font>
00484 <font class="preprocessor"></font>                <font class="keywordflow">if</font> (bindCode != 0 &amp;&amp; WSAGetLastError() == WSAEADDRINUSE)
00485 <font class="preprocessor">#elif defined(HAVE_ERRNO_H)</font>
00486 <font class="preprocessor"></font>                <font class="keywordflow">if</font> (bindCode != 0 &amp;&amp; errno == EADDRINUSE)
00487 <font class="preprocessor">#endif</font>
00488 <font class="preprocessor"></font>                {
00489                         <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Port "</font> &lt;&lt; port &lt;&lt; <font class="stringliteral">" appears to be in use"</font>);
00490                         inUse = <font class="keyword">true</font>;
00491                 }
00492                 <font class="keywordflow">else</font>
00493                 {
00494                         <font class="comment">// Binding was successful.  Now try listening on the port.</font>
00495                         <font class="comment">// If we can listen, then it's not in use.</font>
00496 
00497                         <font class="keywordtype">int</font> listenCode = listen(sock, 1);
00498 <font class="preprocessor">#if defined(WIN32)</font>
00499 <font class="preprocessor"></font>                        <font class="keywordflow">if</font> (listenCode != 0 &amp;&amp; WSAGetLastError() == WSAEADDRINUSE)
00500 <font class="preprocessor">#elif defined(HAVE_ERRNO_H)</font>
00501 <font class="preprocessor"></font>                        <font class="keywordflow">if</font> (listenCode != 0 &amp;&amp; errno == EADDRINUSE)
00502 <font class="preprocessor">#endif</font>
00503 <font class="preprocessor"></font>                        {
00504                                 <a class="code" href="portableOS_8h.html#a2">TRACE</a>(<font class="stringliteral">"Port "</font> &lt;&lt; port &lt;&lt; <font class="stringliteral">" appears to be in use"</font>);
00505                                 inUse = <font class="keyword">true</font>;
00506                         }
00507                 }
00508 
00509                 <a class="code" href="SBWOSSocket_8h.html#a7">closesocket</a>(sock);
00510                 <font class="keywordflow">return</font> inUse;
00511     }
00512 
00513     <font class="keywordflow">return</font> inUse;
00514 }
</pre></div><hr>
<br>
<address>
<center>
<b>Systems Biology Workbench Development Group</b><br>
ERATO Kitano Systems Biology Project<br>
Control and Dynamical Systems, MC 107-81<br>
California Institute of Technology, Pasadena, CA 91125, USA<br>
<A HREF="mailto:sysbio-team@caltech.edu">sysbio-team@caltech.edu</A><br>
<A HREF="http://www.cds.caltech.edu/erato">http://www.cds.caltech.edu/erato</A><br><br>
<small>
Generated on Fri Nov 22 00:10:05 2002 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.2.14
</small>
</center>
</address>
</body>
</html>
